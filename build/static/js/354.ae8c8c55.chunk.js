"use strict";(self.webpackChunklittle_fighter_j=self.webpackChunklittle_fighter_j||[]).push([[354],{8354:(t,e)=>{var i,s,r;e.sV=void 0,(i=e.sV||(e.sV={})).pickShapePosData=function(t){return{i:t.i,x:t.x,y:t.y}},i.pickShapeGeoData=function(t){return{i:t.i,x:t.x,y:t.y,w:t.w,h:t.h,r:t.r}},e._L=void 0,(s=e._L||(e._L={})).Invalid="",s.ShapesAdded="SHAPES_ADDED",s.ShapesRemoved="SHAPES_REMOVED",s.ShapesChanging="SHAPES_CHANGING",s.ShapesChanged="SHAPES_CHANGED",s.ShapesDone="SHAPES_DONE",s.ShapesGeoChanging="SHAPES_GEO_CHANGING",s.ShapesGeoChanged="SHAPES_GEO_CHANGED",s.ToolChanged="TOOL_CHANGED",s.LayerAdded="LAYER_ADDED",s.LayerRemoved="LAYER_REMOVED",s.ShapesSelected="SHAPES_SELECTED",s.ShapesDeselected="SHAPES_DESELECTED",s.WorldRectChanged="WORLD_RECT_CHANGED",s.ViewportChanged="VIEWPORT_CHANGED";class h{constructor(t,e){this.from=t,this.to=e}set(t){this.from=t.from,this.to=t.to}get mid(){return(this.from+this.to)/2}hit(t){return!(this.from>t.to)&&!(this.to<t.from)}}class o{constructor(t){this._range=new h(0,0),this._items=[],this._itemCount=0,this._level=0,this._opts=Object.assign({},t),this._range.set(t.range)}get children(){return[this._child0,this._child1]}get maxItems(){return this._opts.maxItems||20}get parent(){return this._parent}get level(){return this._level}get itemCount(){return this._itemCount}get range(){return this._range}get items(){return this._items}get child0(){return this._child0}get child1(){return this._child1}get genChild0(){return this._child0||(this._child0=new o(Object.assign(Object.assign({},this._opts),{range:this.childRange0})),this._child0._parent=this,this._child0._level=this._level+1),this._child0}get genChild1(){return this._child1||(this._child1=new o(Object.assign(Object.assign({},this._opts),{range:this.childRange1})),this._child1._parent=this,this._child1._level=this._level+1),this._child1}get childRange0(){return this._childRange0||(this._childRange0=new h(this._range.from,this._range.mid)),this._childRange0}get childRange1(){return this._childRange1||(this._childRange1=new h(this._range.mid,this._range.to)),this._childRange1}split(){if(this._child0&&this._child1)return;let t,e,i,s,r;for(let h=0;h<this._items.length;++h)t=this._items[h],e=this._opts.getItemRange(t),i=this.childRange0.hit(e)?1:0,s=this.childRange1.hit(e)?1:0,r=i+s,1===r&&(this._items.splice(h,1),--h,i?(this.genChild0.insert(t),this._opts.onTreeChanged&&this._opts.onTreeChanged(t,this,this.genChild0)):s&&(this.genChild1.insert(t),this._opts.onTreeChanged&&this._opts.onTreeChanged(t,this,this.genChild1)))}insert(t){++this._itemCount;const e=this._opts.getItemRange(t),i=this._itemCount>=this.maxItems;if(i&&this.split(),i){const i=this.childRange0.hit(e)?1:0,s=this.childRange1.hit(e)?1:0;if(i)return this.genChild0.insert(t);if(s)return this.genChild1.insert(t)}return this._items.push(t),this}removeOnlyUnderMe(t){const e=this._items.indexOf(t);return e>=0&&(--this._itemCount,this._items.splice(e,1),!0)}remove(t){var e,i,s,r;if(this._opts.getTree){let s=this._opts.getTree(t);if(!s)return!1;const r=s.removeOnlyUnderMe(t);let h;s._itemCount++;do{--s._itemCount,s._itemCount<=0?((null===(e=s.parent)||void 0===e?void 0:e._child0)===s&&delete s.parent._child0,(null===(i=s.parent)||void 0===i?void 0:i._child1)===s&&delete s.parent._child1):s._itemCount<this.maxItems&&(h=s),s=s.parent}while(s);return null===h||void 0===h||h.merge(),r}if(this.removeOnlyUnderMe(t))return!0;if(null===(s=this._child0)||void 0===s?void 0:s.remove(t))!this._child0.itemCount&&delete this._child0;else{if(!(null===(r=this._child1)||void 0===r?void 0:r.remove(t)))return!1;!this._child1.itemCount&&delete this._child1}return--this._itemCount,this._itemCount<this.maxItems&&this.merge(),!0}merge(){this.children.forEach(t=>{t&&(t.merge(),t._items.forEach(e=>{this.items.push(e),this._opts.onTreeChanged&&this._opts.onTreeChanged(e,t,this)}))}),delete this._child0,delete this._child1}}class n{get top(){return this.y}get left(){return this.x}get right(){return this.x+this.w}get bottom(){return this.y+this.h}set top(t){this.h=this.bottom-t,this.y=t}set left(t){this.w=this.right-t,this.x=t}set right(t){this.w=t-this.x}set bottom(t){this.h=t-this.y}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;this.x=t,this.y=e,this.w=i,this.h=s}pure(){return{x:this.x,y:this.y,w:this.w,h:this.h}}set(t){this.x=t.x,this.y=t.y,this.w=t.w,this.h=t.h}hit(t){return n.hit(this,t)}toString(){return`Rect(x=${this.x}, y=${this.x}, w=${this.w}, h=${this.h})`}moveTo(t,e){return this.x=t,this.y=e,this}mid(){return{x:this.x+this.w/2,y:this.y+this.h/2}}static create(t){return new n(t.x,t.y,t.w,t.h)}static pure(t,e,i,s){return{x:t,y:e,w:i,h:s}}static bounds(t,e){const i=Math.min(t.x,e.x),s=Math.min(t.y,e.y);return{x:i,y:s,w:Math.max(t.x+t.w,e.x+e.w)-i,h:Math.max(t.y+t.h,e.y+e.h)-s}}static hit(t,e){let i=0,s=0;return"w"in e&&"h"in e&&(i=e.w,s=e.h),t.x+t.w>=e.x&&e.x+i>=t.x&&t.y+t.h>=e.y&&e.y+s>=t.y}static intersect(t,e){const i=Math.max(t.x,e.x),s=Math.max(t.y,e.y);return{x:i,y:s,w:Math.min(t.x+t.w,e.x+e.w)-i,h:Math.min(t.y+t.h,e.y+e.h)-s}}}class a{constructor(t){this._items=[],this._itemCount=0,this._rect=new n(0,0,0,0),this._level=0,this._opts=Object.assign({},t),this._rect.set(t.rect)}get children(){return[this._child0,this._child1,this._child2,this._child3]}get maxItems(){return this._opts.maxItems||20}get parent(){return this._parent}get level(){return this._level}get itemCount(){return this._itemCount}get rect(){return this._rect}get items(){return this._items}get child0(){return this._child0}get child1(){return this._child1}get child2(){return this._child2}get child3(){return this._child3}get genChild0(){return this._child0||(this._child0=new a(Object.assign(Object.assign({},this._opts),{rect:this.childRect0})),this._child0._parent=this,this._child0._level=this._level+1),this._child0}get genChild1(){return this._child1||(this._child1=new a(Object.assign(Object.assign({},this._opts),{rect:this.childRect1})),this._child1._parent=this,this._child1._level=this._level+1),this._child1}get genChild2(){return this._child2||(this._child2=new a(Object.assign(Object.assign({},this._opts),{rect:this.childRect2})),this._child2._parent=this,this._child2._level=this._level+1),this._child2}get genChild3(){return this._child3||(this._child3=new a(Object.assign(Object.assign({},this._opts),{rect:this.childRect3})),this._child3._parent=this,this._child3._level=this._level+1),this._child3}get childRect0(){if(!this._childRect0){const{x:t,y:e}=this.rect,i=this.rect.w/2,s=this.rect.h/2;this._childRect0=new n(t,e,i,s)}return this._childRect0}get childRect1(){if(!this._childRect1){const{y:t}=this.rect,e=this.rect.w/2,i=this.rect.h/2,{x:s}=this.rect.mid();this._childRect1=new n(s,t,e,i)}return this._childRect1}get childRect2(){if(!this._childRect2){const{x:t}=this.rect,e=this.rect.w/2,i=this.rect.h/2,{y:s}=this.rect.mid();this._childRect2=new n(t,s,e,i)}return this._childRect2}get childRect3(){if(!this._childRect3){const t=this.rect.w/2,e=this.rect.h/2,{x:i,y:s}=this.rect.mid();this._childRect3=new n(i,s,t,e)}return this._childRect3}split(){if(this._child0&&this._child1&&this._child2&&this._child3)return;let t,e,i,s,r,h,o;for(let n=0;n<this._items.length;++n)t=this._items[n],e=this._opts.getItemRect(t),i=this.childRect0.hit(e)?1:0,s=this.childRect1.hit(e)?1:0,r=this.childRect2.hit(e)?1:0,h=this.childRect3.hit(e)?1:0,o=i+s+r+h,1===o&&(this._items.splice(n,1),--n,i?(this.genChild0.insert(t),this._opts.onTreeChanged&&this._opts.onTreeChanged(t,this,this.genChild0)):s?(this.genChild1.insert(t),this._opts.onTreeChanged&&this._opts.onTreeChanged(t,this,this.genChild1)):r?(this.genChild2.insert(t),this._opts.onTreeChanged&&this._opts.onTreeChanged(t,this,this.genChild2)):h&&(this.genChild3.insert(t),this._opts.onTreeChanged&&this._opts.onTreeChanged(t,this,this.genChild3)))}insert(t){++this._itemCount;const e=this._opts.getItemRect(t),i=this._itemCount>=this.maxItems;if(i&&this.split(),i){const i=this.childRect0.hit(e)?1:0,s=this.childRect1.hit(e)?1:0,r=this.childRect2.hit(e)?1:0,h=this.childRect3.hit(e)?1:0;if(i)return this.genChild0.insert(t);if(s)return this.genChild1.insert(t);if(r)return this.genChild2.insert(t);if(h)return this.genChild3.insert(t)}return this._items.push(t),this}removeOnlyUnderMe(t){const e=this._items.indexOf(t);return e>=0&&(--this._itemCount,this._items.splice(e,1),!0)}remove(t){var e,i,s,r,h,o,n,a;if(this._opts.getTree){let h=this._opts.getTree(t);if(!h)return!1;const o=h.removeOnlyUnderMe(t);let n;h._itemCount++;do{--h._itemCount,h._itemCount<=0?((null===(e=h.parent)||void 0===e?void 0:e._child0)===h&&delete h.parent._child0,(null===(i=h.parent)||void 0===i?void 0:i._child1)===h&&delete h.parent._child1,(null===(s=h.parent)||void 0===s?void 0:s._child2)===h&&delete h.parent._child2,(null===(r=h.parent)||void 0===r?void 0:r._child3)===h&&delete h.parent._child3):h._itemCount<this.maxItems&&(n=h),h=h.parent}while(h);return null===n||void 0===n||n.merge(),o}if(this.removeOnlyUnderMe(t))return!0;if(null===(h=this._child0)||void 0===h?void 0:h.remove(t))!this._child0.itemCount&&delete this._child0;else if(null===(o=this._child1)||void 0===o?void 0:o.remove(t))!this._child1.itemCount&&delete this._child1;else if(null===(n=this._child2)||void 0===n?void 0:n.remove(t))!this._child2.itemCount&&delete this._child2;else{if(!(null===(a=this._child3)||void 0===a?void 0:a.remove(t)))return!1;!this._child3.itemCount&&delete this._child3}return--this._itemCount,this._itemCount<this.maxItems&&this.merge(),!0}merge(){this.children.forEach(t=>{t&&(t.merge(),t._items.forEach(e=>{this.items.push(e),this._opts.onTreeChanged&&this._opts.onTreeChanged(e,t,this)}))}),delete this._child0,delete this._child1,delete this._child2,delete this._child3}}class d{constructor(t,e){this.x=0,this.y=0,this.x=t,this.y=e}plus(t){return this.add(t.x,t.y)}add(t,e){return this.x+=t,this.y+=e,this}static mid(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5;return{x:t.x+(e.x-t.x)*i,y:t.y+(e.y-t.y)*i}}static pure(t,e){return{x:t,y:e}}static distance(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}static manhattan(t,e){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}static dot(t,e){return Math.abs(t.x*e.x+t.y*e.y)}static multiply(t,e){return{x:t.x*e,y:t.y*e}}}class l{get axisX(){return this._axisX}get axisY(){return this._axisY}set top(t){this.h=this.bottom-t,this.y=t}set left(t){this.w=this.right-t,this.x=t}set right(t){this.w=t-this.x}set bottom(t){this.h=t-this.y}get r(){return this._r}set r(t){this._r=t,this._cr=Math.cos(t),this._sr=Math.sin(t),this._axisX={x:this._cr,y:this._sr},this._axisY={x:-this._sr,y:this._cr}}get middleX(){return this.x+this.w/2}get middleY(){return this.y+this.h/2}set middleX(t){this.x=t-this.w/2}set middleY(t){this.y=t-this.h/2}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;this._r=0,this._cr=0,this._sr=0,this._axisX={x:0,y:0},this._axisY={x:0,y:0},this.x=t,this.y=e,this.w=i,this.h=s,this._cr=Math.cos(r),this._sr=Math.sin(r),this._axisX={x:this._cr,y:this._sr},this._axisY={x:-this._sr,y:this._cr},this._r=r}set(t){return this.x=t.x,this.y=t.y,this.w=t.w,this.h=t.h,this.r=t.r||0,this}hit(t){return l.hit(this,t)}toString(){return`RotatedRect(x=${this.x}, y=${this.x}, w=${this.w}, h=${this.h}, r=${this.r})`}moveTo(t,e){return this.x=t,this.y=e,this}mid(){return{x:this.x+this.w/2,y:this.y+this.h/2}}static create(t){return new l(t.x,t.y,t.w,t.h,t.r)}static pure(t,e,i,s,r){return{x:t,y:e,w:i,h:s,r:r}}static hit(t,e){if(!t.r&&!e.r)return n.hit(t,e);const i=t instanceof l?t:new l(t.x,t.y,t.w,t.h,t.r),s=e instanceof l?e:new l(e.x,e.y,e.w,e.h,e.r),r={x:i.middleX-s.middleX,y:i.middleY-s.middleY},h=[i._axisX,i._axisY,s._axisX,s._axisY];for(let o=0,n=h.length;o<n;o++){const t=h[o];if(i.projection(t)+s.projection(t)<=2*d.dot(r,t))return!1}return!0}projection(t){const e=d.dot(this._axisX,t),i=d.dot(this._axisY,t);return e*this.w+i*this.h}}e.FQ=void 0,(e.FQ||(e.FQ={})).equals=function(t,e){return Math.abs(t-e)<=Number.EPSILON},e.a3=void 0,(r=e.a3||(e.a3={})).normalized=function(t){return t?e.FQ.equals(0,t)?0:t<0?t%(2*Math.PI)+2*Math.PI:t%(2*Math.PI):t},r.angle=function(t){return t?180*t/Math.PI:t},e.DO=void 0,(e.DO||(e.DO={})).firstOf=function(t,e){for(let i=0,s=t.length;i<s;i++){const s=e(t[i]);if(null!==s&&void 0!==s)return s}return null};const c=t=>"number"===typeof t,_=t=>"string"===typeof t,u=(t,e)=>i=>{const s=((t,e)=>Object.keys(t).find(i=>t[i]===e))(e,i);return _(s)?`${t}.${s}`:""+i};var p;e.B$=void 0,(p=e.B$||(e.B$={}))[p.Invalid=0]="Invalid",p[p.Pen=1]="Pen",p[p.Rect=2]="Rect",p[p.Oval=3]="Oval",p[p.Text=4]="Text",p[p.Polygon=5]="Polygon",p[p.Tick=6]="Tick",p[p.Cross=7]="Cross",p[p.HalfTick=8]="HalfTick",p[p.Lines=9]="Lines",p[p.Img=10]="Img";const g=u("ShapeType",e.B$);class y{get visible(){return 0!=this.v}set visible(t){t?delete this.v:this.v=0}get selected(){return!!this.s}set selected(t){t?this.s=1:delete this.s}get editing(){return!!this.e}set editing(t){t?this.e=1:delete this.e}get locked(){return!!this.f}set locked(t){t?this.f=1:delete this.f}get ghost(){return!!this.g}set ghost(t){t?this.g=1:delete this.g}merge(t){return this.read(t),this}read(t){return c(t.v)&&(this.v=t.v),c(t.s)&&(this.s=t.s),c(t.e)&&(this.e=t.e),c(t.f)&&(this.f=t.f),c(t.g)&&(this.g=t.g),this}copy(){return(new(Object.getPrototypeOf(this).constructor)).read(this)}}class m{get fillStyle(){return this.b||""}set fillStyle(t){t?this.b=t:delete this.b}get strokeStyle(){return this.a||""}set strokeStyle(t){t?this.a=t:delete this.a}get lineCap(){return this.c||"round"}set lineCap(t){t?this.c=t:delete this.c}get lineDash(){return this.d||[]}set lineDash(t){Array.isArray(t)&&t.length>0?this.d=[...t]:delete this.d}get lineDashOffset(){return this.e||0}set lineDashOffset(t){t?this.e=t:delete this.e}get lineJoin(){return this.f||"round"}set lineJoin(t){t?this.f=t:delete this.f}get lineWidth(){return this.g||0}set lineWidth(t){t?this.g=t:delete this.g}get miterLimit(){return this.h||0}set miterLimit(t){t?this.h=t:delete this.h}merge(t){return this.read(t)}read(t){return t.a&&(this.a=t.a),t.b&&(this.b=t.b),t.c&&(this.c=t.c),t.d&&(this.d=[...t.d]),c(t.e)&&(this.e=t.e),t.f&&(this.f=t.f),c(t.g)&&(this.g=t.g),c(t.h)&&(this.h=t.h),this}copy(){return(new(Object.getPrototypeOf(this).constructor)).read(this)}}class f{constructor(t){this.t=e.B$.Invalid,this.i="",this.x=0,this.y=0,this.w=0,this.h=0,this.z=0,t&&this.read(t)}get style(){return this.a instanceof m?this.a:this.a?this.a=(new m).merge(this.a):this.a=new m}get status(){return this.b instanceof y?this.b:this.b?this.b=(new y).merge(this.b):this.b=new y}get type(){return this.t}set type(t){this.t=t}get id(){return this.i}set id(t){this.i=t}get scaleX(){var t;return null!==(t=this.c)&&void 0!==t?t:1}set scaleX(t){1==t?delete this.c:this.c=t}get scaleY(){var t;return null!==(t=this.d)&&void 0!==t?t:1}set scaleY(t){1==t?delete this.d:this.d=t}get fillStyle(){return this.style.fillStyle}set fillStyle(t){this.style.fillStyle=t}get strokeStyle(){return this.style.strokeStyle}set strokeStyle(t){this.style.strokeStyle=t}get lineCap(){return this.style.lineCap}set lineCap(t){this.style.lineCap=t}get lineDash(){return this.style.lineDash}set lineDash(t){this.style.lineDash=t}get lineDashOffset(){return this.style.lineDashOffset}set lineDashOffset(t){this.style.lineDashOffset=t}get lineJoin(){return this.style.lineJoin}set lineJoin(t){this.style.lineJoin=t}get lineWidth(){return this.style.lineWidth}set lineWidth(t){this.style.lineWidth=t}get miterLimit(){return this.style.miterLimit}set miterLimit(t){this.style.miterLimit=t}get visible(){return this.status.visible}set visible(t){this.status.visible=t}get selected(){return this.status.selected}set selected(t){this.status.selected=t}get editing(){return this.status.editing}set editing(t){this.status.editing=t}get locked(){return this.status.locked}set locked(t){this.status.locked=t}get ghost(){return this.status.ghost}set ghost(t){this.status.ghost=t}get layer(){return this.l}set layer(t){this.l=t}get needFill(){return!0}get needStroke(){return!0}get rotation(){var t;return null!==(t=this.r)&&void 0!==t?t:0}set rotation(t){this.r=e.a3.normalized(t)}merge(t){return this.read(t),this}read(t){(_(t.t)||c(t.t))&&(this.t=t.t),_(t.i)&&(this.i=t.i),c(t.x)&&(this.x=t.x),c(t.y)&&(this.y=t.y),c(t.z)&&(this.z=t.z),c(t.w)&&(this.w=t.w),c(t.h)&&(this.h=t.h),_(t.l)&&(this.l=t.l),c(t.c)&&(this.c=t.c),_(t.d)&&(this.d=t.d),this.r=c(t.r)?t.r:void 0;const{style:e,status:i}=t,{a:s=e,b:r=i}=t;return s&&this.style.read(s),r&&this.status.read(r),s&&this.style.read(s),r&&this.status.read(r),this}copy(){return(new(Object.getPrototypeOf(this).constructor)).read(this)}wash(){return this.a&&!Object.keys(this.a).length&&delete this.a,this.b&&!Object.keys(this.b).length&&delete this.b,this}}var v,w,x,b;e.r0=void 0,(v=e.r0||(e.r0={})).StartDirty="start_dirty",v.EndDirty="end_dirty",v.BoardChanged="board_changed",e.Cr=void 0,(w=e.Cr||(e.Cr={}))[w.None=0]="None",w[w.Top=1]="Top",w[w.TopRight=2]="TopRight",w[w.Right=3]="Right",w[w.BottomRight=4]="BottomRight",w[w.Bottom=5]="Bottom",w[w.BottomLeft=6]="BottomLeft",w[w.Left=7]="Left",w[w.TopLeft=8]="TopLeft",e.cM=void 0,(x=e.cM||(e.cM={}))[x.None=0]="None",x[x.Horizontal=1]="Horizontal",x[x.Vertical=2]="Vertical",x[x.Corner=4]="Corner",x[x.All=7]="All";class S{constructor(t,i){this._r=e.cM.None,this._relCount=0,this._d=new i(t)}get data(){return this._d}get type(){return this._d.t}get board(){return this._b}set board(t){if(t===this._b)return;const i=this._b;this._b=t,this.dispatchEvent(e.r0.BoardChanged,{shape:this,prev:i})}get visible(){return this._d.visible}set visible(t){if(this._d.visible===t)return;const e={b:{v:t?0:void 0}};this.beginDirty(e),this._d.visible=t,this.endDirty(e)}get editing(){return this._d.editing}set editing(t){if(this._d.editing===t)return;const e={b:{e:t?void 0:1}};this.beginDirty(e),this._d.editing=t,this.endDirty(e)}get selected(){return this._d.selected}set selected(t){if(this._d.selected===t)return;const e={b:{s:t?void 0:1}};this.beginDirty(e),this._d.selected=t,this.endDirty(e)}get resizable(){return this._r}get locked(){return this._d.locked}set locked(t){if(this._d.locked===t)return;const e={b:{f:t?void 0:1}};this.beginDirty(e),this._d.locked=t,this.endDirty(e)}get ghost(){return this._d.ghost}set ghost(t){if(this._d.ghost===t)return;const e={b:{g:t?void 0:1}};this.beginDirty(e),this._d.ghost=t,this.endDirty(e)}get lineWidth(){return this._d.lineWidth}set lineWidth(t){if(!this._d.needStroke)return;const e={a:{g:this._d.lineWidth}};this.beginDirty(e),this._d.lineWidth=Math.max(0,t),this.endDirty(e)}merge(t){const e=this.data.copy();this.beginDirty(e),this.data.merge(t),this.endDirty(e)}beginDirty(t){this.dispatchEvent(e.r0.StartDirty,{shape:this,prev:t}),this.markDirty()}endDirty(t){this.markDirty(),this.dispatchEvent(e.r0.EndDirty,{shape:this,prev:t})}markDirty(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.boundingRect();var e;null===(e=this.board)||void 0===e||e.markDirty(t)}move(t,e){this.geo(t,e,this._d.w,this._d.h)}resize(t,e){this.geo(this._d.x,this._d.y,t,e)}get x(){return this._d.x}get y(){return this._d.y}get halfW(){return this._d.w/2}get halfH(){return this._d.h/2}get midX(){return this._d.x+this.halfW}get midY(){return this._d.y+this.halfH}get w(){return this._d.w}get h(){return this._d.h}get left(){return this._d.x}get right(){return this._d.y}get top(){return this._d.w+this._d.x}get bottom(){return this._d.h+this._d.y}get topLeft(){return{x:this.left,y:this.top}}get bottomLeft(){return{x:this.left,y:this.bottom}}get topRight(){return{x:this.right,y:this.top}}get bottomRight(){return{x:this.right,y:this.bottom}}get leftTop(){return this.topLeft}get leftBottom(){return this.bottomLeft}get rightTop(){return this.topRight}get rightBottom(){return this.bottomRight}get rotatedTopLeft(){return this.map2world(0,0)}get rotatedBottomLeft(){return this.map2world(0,this.h)}get rotatedTopRight(){return this.map2world(this.w,0)}get rotatedBottomRight(){return this.map2world(this.w,this.h)}get rotatedLeftTop(){return this.map2world(0,0)}get rotatedLeftBottom(){return this.map2world(0,this.h)}get rotatedRightTop(){return this.map2world(this.w,0)}get rotatedRightBottom(){return this.map2world(this.w,this.h)}get midTop(){return{x:this.midX,y:this.top}}get midBottom(){return{x:this.midX,y:this.bottom}}get midLeft(){return{x:this.left,y:this.midY}}get midRight(){return{x:this.right,y:this.midY}}get rotatedMidTop(){return this.map2world(this.halfW,0)}get rotatedMidBottom(){return this.map2world(this.halfW,this.h)}get rotatedMidLeft(){return this.map2world(0,this.halfH)}get rotatedMidRight(){return this.map2world(this.w,this.halfH)}get rotatedMid(){return this.map2world(this.halfW,this.halfH)}get rotation(){return this.data.rotation}rotateBy(t){const e=this._d.rotation+t;this.rotateTo(e)}rotateTo(t){if(t==this._d.rotation)return;const e={x:this._d.x,y:this._d.y,r:this._d.r};this.beginDirty(e),this._d.rotation=t%(2*Math.PI),this.endDirty(e)}getGeo(){return new n(this._d.x,this._d.y,this._d.w,this._d.h)}setGeo(t){this.geo(t.x,t.y,t.w,t.h)}geo(t,e,i,s){if(t===this._d.x&&e===this._d.y&&i===this._d.w&&s===this._d.h)return;const r={x:this._d.x,y:this._d.y,w:this._d.w,h:this._d.h};this.beginDirty(r),this._d.x=t,this._d.y=e,this._d.w=i,this._d.h=s,this.endDirty(r)}moveBy(t,e){this.geo(this._d.x+t,this._d.y+e,this._d.w,this._d.h)}resizeBy(t,e){this.geo(this._d.x,this._d.y,this._d.w+t,this._d.h+e)}geoBy(t,e,i,s){this.geo(this._d.x+t,this._d.y+e,this._d.w+i,this._d.h+s)}render(t){var e,i,s,r,h,o;if(!this.visible)return;const n=null===(e=this.board)||void 0===e?void 0:e.factory.shapeDecoration(this),{ghost:a,locked:d,resizable:l,selected:c}=this;this.beginDraw(t),a&&(null===(i=null===n||void 0===n?void 0:n.ghost)||void 0===i||i.call(n,this,t)),c&&d&&(null===(s=null===n||void 0===n?void 0:n.locked)||void 0===s||s.call(n,this,t)),c&&!d&&(null===(r=null===n||void 0===n?void 0:n.selected)||void 0===r||r.call(n,this,t)),c&&!d&&l&&(null===(h=null===n||void 0===n?void 0:n.resizable)||void 0===h||h.call(n,this,t)),this.endDraw(t),null===(o=null===n||void 0===n?void 0:n.debug)||void 0===o||o.call(n,this,t)}drawingRect(){const t=this._d;return{x:0,y:0,w:Math.floor(t.w),h:Math.floor(t.h)}}selectorRect(){const{w:t,h:e,locked:i,lineWidth:s}=this.data,r=Math.floor(s/2),h=i?0:.5;return{x:h-r,y:h-r,w:Math.floor(t+2*r)-1,h:Math.floor(e+2*r)-1}}boundingRect(){var t;const e=this.data,i=e.lineWidth%2?1:0,s=(null===(t=this.board)||void 0===t?void 0:t.factory.overbound(this))||1,r=2*s;if(!e.r)return{x:Math.floor(e.x-e.lineWidth/2-s),y:Math.floor(e.y-e.lineWidth/2-s),w:Math.ceil(e.w+e.lineWidth+i+r),h:Math.ceil(e.h+e.lineWidth+i+r)};const h=Math.abs(e.w*Math.cos(e.r))+Math.abs(e.h*Math.sin(e.r)),o=Math.abs(e.w*Math.sin(e.r))+Math.abs(e.h*Math.cos(e.r)),n=e.x-(h-e.w)/2,a=e.y-(o-e.h)/2;return{x:Math.floor(n-e.lineWidth/2-s),y:Math.floor(a-e.lineWidth/2-s),w:Math.ceil(h+e.lineWidth+i+r),h:Math.ceil(o+e.lineWidth+i+r)}}getResizerNumbers(t,e,i,s){var r;const h=(null===(r=this._b)||void 0===r?void 0:r.factory.resizer.size)||10;return{s:h,lx:t,rx:t+i-h,ty:e,by:e+s-h,mx:Math.floor(t+(i-h)/2)-.5,my:Math.floor(e+(s-h)/2)-.5}}map2me(t,e){const i=c(t)?t:t.x,s=c(t)?e:t.y,{r:r,x:h,y:o}=this.data;if(!r)return new d(i-h,s-o);const n=this.midX,a=this.midY,l=Math.cos(-r),_=Math.sin(-r),u=i-n,p=s-a;return new d(u*l-p*_+n-h,u*_+p*l+a-o)}map2world(t,e){const i=c(t)?t:t.x,s=c(t)?e:t.y,{r:r,x:h,y:o,w:n,h:a}=this.data;if(!r)return{x:i+h,y:s+o};const d=n/2,l=a/2,_=Math.cos(r),u=Math.sin(r),p=i-d,g=s-l;return{x:p*_-g*u+d+h,y:p*u+g*_+l+o}}resizeDirection(t,i){if(!this.selected||!this._r||this.ghost||this.locked)return[e.Cr.None,void 0];const{x:s,y:r}=this.data,{x:h,y:o,w:a,h:d}=this.selectorRect(),{s:l,lx:c,rx:_,ty:u,by:p,mx:g,my:y}=this.getResizerNumbers(s+h,r+o,a,d),m={x:t,y:i},f=new n(0,0,l,l);return f.moveTo(g,u),f.hit(m)?[e.Cr.Top,f]:(f.moveTo(g,p),f.hit(m)?[e.Cr.Bottom,f]:(f.moveTo(c,y),f.hit(m)?[e.Cr.Left,f]:(f.moveTo(_,y),f.hit(m)?[e.Cr.Right,f]:(f.moveTo(c,u),f.hit(m)?[e.Cr.TopLeft,f]:(f.moveTo(_,u),f.hit(m)?[e.Cr.TopRight,f]:(f.moveTo(c,p),f.hit(m)?[e.Cr.BottomLeft,f]:(f.moveTo(_,p),f.hit(m)?[e.Cr.BottomRight,f]:[e.Cr.None,void 0])))))))}beginDraw(t){let{x:e,y:i,w:s,h:r,r:h,c:o,d:n}=this.data;t.save(),e=Math.floor(e),i=Math.floor(i);const a=Math.floor(s/2),d=Math.floor(r/2);h||o||n?(t.translate(e+a,i+d),h&&t.rotate(h),(o||n)&&t.scale(null!==o&&void 0!==o?o:1,null!==n&&void 0!==n?n:1),t.translate(-a,-d)):t.translate(e,i)}endDraw(t){t.restore()}addEventListener(t,e,i){return this._ele=this._ele||document.createElement("a"),this._ele.addEventListener(t,e,i),(null===i||void 0===i?void 0:i.once)||this._relCount++,this}removeEventListener(t,e,i){var s;return null===(s=this._ele)||void 0===s||s.removeEventListener(t,e,i),this}dispatchEvent(t,e){var i;return null===(i=this._ele)||void 0===i||i.dispatchEvent(new CustomEvent(t,{detail:e})),this}}class D extends S{constructor(t,i){super(t,i),this._r=e.cM.All}path(t){throw new Error("Method 'path' not implemented.")}render(t){if(!this.visible)return;this.beginDraw(t);const e=this.data;(e.fillStyle||e.lineWidth&&e.strokeStyle)&&this.path(t),e.fillStyle&&(t.fillStyle=e.fillStyle,t.fill()),e.lineWidth&&e.strokeStyle&&(t.lineCap=e.lineCap,t.lineDashOffset=e.lineDashOffset,t.lineJoin=e.lineJoin,t.lineWidth=e.lineWidth,t.miterLimit=e.miterLimit,t.strokeStyle=e.strokeStyle,t.setLineDash(e.lineDash),t.stroke()),this.endDraw(t),super.render(t)}}class T extends f{get needFill(){return!1}constructor(t){super(t),this.type=e.B$.Cross,this.strokeStyle="#FF0000",this.lineWidth=2,t&&this.read(t)}}e.s8=void 0,(b=e.s8||(e.s8={})).Invalid="",b.Selector="TOOL_SELECTOR",b.Pen="TOOL_PEN",b.Rect="TOOL_RECT",b.Oval="TOOL_OVAL",b.Text="TOOL_TEXT",b.Polygon="TOOL_POLYGON",b.Tick="TOOL_TICK",b.Cross="TOOL_CROSS",b.HalfTick="TOOL_HALFTICK",b.Lines="TOOL_Lines",b.Img="TOOL_Img";const C=u("ToolEnum",e.s8),k="[Gaia]";class L{static registerFactory(t,e,i){this._factorys.has(t)?console.warn(k,`registerFactory(), factory '${t}' already exists!`):this._factoryInfos.has(t)&&console.warn(k,`registerFactory(), factory info '${t}' already exists!`),this._factorys.set(t,e),this._factoryInfos.set(t,i)}static listFactories(){return Array.from(this._factoryInfos.keys())}static factory(t){return this._factorys.get(t)}static registerTool(t,e,i){this._tools.has(t)?console.warn(k,`registerTool(), tool '${t}' already exists!`):this._toolInfos.has(t)&&console.warn(k,`registerTool(), tool info '${t}' already exists!`),this._tools.set(t,e),this._toolInfos.set(t,{shape:null===i||void 0===i?void 0:i.shape,name:(null===i||void 0===i?void 0:i.name)||C(t),desc:(null===i||void 0===i?void 0:i.desc)||C(t)})}static listTools(){return Array.from(this._tools.keys())}static tool(t){return this._tools.get(t)}static toolInfo(t){return this._toolInfos.get(t)}static editToolInfo(t,e){let i=this._toolInfos.get(t);i&&(i=e(i),this._toolInfos.set(t,i))}static registerShape(t,e,i,s){this._shapeInfos.has(t)?console.warn(k,`registerShape(), shape info '${t}' already exists!`):this._shapeDatas.has(t)?console.warn(k,`registerShape(), shape data'${t}' already exists!`):this._shapes.has(t)&&console.warn(k,`registerShape(), shape '${t}' already exists!`),this._shapeInfos.set(t,{name:(null===s||void 0===s?void 0:s.name)||g(t),desc:(null===s||void 0===s?void 0:s.desc)||g(t),type:t}),this._shapeDatas.set(t,e),this._shapes.set(t,i)}static listShapes(){return Array.from(this._shapes.keys())}static shapeInfo(t){return this._shapeInfos.get(t)}static shapeData(t){return this._shapeDatas.get(t)}static shape(t){return this._shapes.get(t)}static registAction(t,e){this._actionHandler.set(t,e)}static listActions(){return Array.from(this._actionHandler.keys())}static action(t){return this._actionHandler.get(t)}}L._tools=new Map,L._toolInfos=new Map,L._shapeDatas=new Map,L._shapes=new Map,L._shapeInfos=new Map,L._factorys=new Map,L._factoryInfos=new Map,L._actionHandler=new Map;class R extends D{constructor(t){super(t,T)}path(t){const{x:e,y:i,w:s,h:r}=this.drawingRect(),h={x:e,y:i+.05*r},o={x:e+s,y:i+r-.05*r},n={x:e+.05*s,y:i+r},a={x:e+s-.05*s,y:i};t.beginPath(),t.moveTo(h.x,h.y),t.quadraticCurveTo(e+s/2+.2*s,i+r/2+.1*r,o.x,o.y),t.moveTo(n.x,n.y),t.quadraticCurveTo(e+s/2-.05*s,i+r/2-.1*r,a.x,a.y)}}var M,E,P,O;L.registerShape(e.B$.Cross,()=>new T,t=>new R(t)),function(t){t[t.FromCorner=0]="FromCorner",t[t.FromCenter=1]="FromCenter"}(M||(M={})),function(t){t[t.Default=0]="Default",t[t.Square=1]="Square",t[t.Circle=2]="Circle"}(E||(E={}));class A{constructor(){this._from=d.pure(NaN,NaN),this._to=d.pure(NaN,NaN)}get ok(){return isNaN(this._from.x)||isNaN(this._to.x)}get from(){return this._from}get to(){return this._to}start(t,e){this._from.x=t,this._from.y=e,this._to.x=t,this._to.y=e}end(t,e){this._to.x=t,this._to.y=e}clear(){this._from=d.pure(NaN,NaN),this._to=d.pure(NaN,NaN)}gen(){const{x:t,y:e}=this._from,{x:i,y:s}=this._to,r=Math.min(t,i),h=Math.min(e,s);return{x:r,y:h,w:Math.max(t,i)-r,h:Math.max(e,s)-h}}}class B{get type(){return this._type}constructor(t,e){this._keys=new Map,this.keydown=t=>{switch(t.key){case"Control":case"Alt":case"Shift":return this._keys.set(t.key,!0),void this.applyRect()}},this.keyup=t=>{switch(t.key){case"Control":case"Alt":case"Shift":return this._keys.set(t.key,!1),void this.applyRect()}},this._rect=new A,this._type=t,this._shapeType=e}holdingKey(){for(let t=0;t<arguments.length;++t)if(!this._keys.get(t<0||arguments.length<=t?void 0:arguments[t]))return!1;return!0}start(){window.addEventListener("keydown",this.keydown),window.addEventListener("keyup",this.keyup)}end(){window.removeEventListener("keydown",this.keydown),window.removeEventListener("keyup",this.keyup),delete this._curShape}render(){}get board(){return this._board}set board(t){this._board=t}pointerMove(t){}pointerDown(t){const{x:e,y:i}=t,s=this.board;if(!s)return;this._curShape=s.factory.newShape(this._shapeType),this._curShape.data.layer=s.layer().id;const r=this._curShape;r&&(s.add(r,!0),this._rect.start(e,i),this.updateGeo(0))}pointerDraw(t){const{x:e,y:i}=t;this._rect.end(e,i),this.updateGeo(1)}pointerUp(t){const{x:e,y:i}=t;this._rect.end(e,i),this.updateGeo(2),delete this._curShape}applyRect(){var t;const{x:e,y:i,w:s,h:r}=this._rect.gen();null===(t=this._curShape)||void 0===t||t.geo(e,i,s,r)}updateGeo(t){const i=this._curShape,s=this.board;if(i&&s)switch(t){case 0:this._prevData=e.sV.pickShapeGeoData(i.data),this._startData=this._prevData,this.applyRect();break;case 1:{this.applyRect();const t=e.sV.pickShapeGeoData(i.data);s.emitEvent(e._L.ShapesGeoChanging,{operator:s.whoami,tool:this.type,shapeDatas:[[t,this._prevData]]}),this._prevData=t;break}case 2:{this.applyRect();const t=e.sV.pickShapeGeoData(i.data);s.emitEvent(e._L.ShapesGeoChanging,{operator:s.whoami,tool:this.type,shapeDatas:[[t,this._prevData]]}),s.emitEvent(e._L.ShapesGeoChanged,{operator:s.whoami,tool:this.type,shapeDatas:[[t,this._startData]]}),s.emitEvent(e._L.ShapesDone,{operator:s.whoami,shapeDatas:[i.data.copy()]}),this._prevData=t;break}}}}L.registerTool(e.s8.Cross,()=>new B(e.s8.Cross,e.B$.Cross),{name:"Cross",desc:"cross drawer",shape:e.B$.Cross});class I extends f{get needFill(){return!1}constructor(t){super(t),this.type=e.B$.HalfTick,this.strokeStyle="#FF0000",this.lineWidth=2,t&&this.read(t)}}class z extends D{constructor(t){super(t,I)}path(t){const{x:e,y:i,w:s,h:r}=this.drawingRect(),h={x:e,y:i+.7*r},o={x:e+s/3,y:i+r},n={x:e+s,y:i};t.beginPath(),t.moveTo(h.x,h.y),t.bezierCurveTo(h.x+(o.x-h.x)/3,h.y,o.x,o.y-(o.y-h.y)/3,o.x,o.y),t.bezierCurveTo(o.x,o.y-(o.y-n.y)/3,n.x-(n.x-o.x)/4,n.y,n.x,n.y);const a={x:e+.35*s,y:i+.25*r},d={x:e+.7*s,y:i+.7*r};t.moveTo(a.x,a.y),t.lineTo(d.x,d.y)}}L.registerShape(e.B$.HalfTick,()=>new I,t=>new z(t)),L.registerTool(e.s8.HalfTick,()=>new B(e.s8.HalfTick,e.B$.HalfTick),{name:"Half tick",desc:"half tick drawer",shape:e.B$.HalfTick}),e.LX=void 0,(P=e.LX||(e.LX={}))[P.Fill=0]="Fill",P[P.Contain=1]="Contain",P[P.Cover=2]="Cover";class F extends f{get src(){var t;return null!==(t=this.s)&&void 0!==t?t:""}set src(t){t?this.s=t:delete this.s}get objectFit(){var t;return null!==(t=this.f)&&void 0!==t?t:e.LX.Fill}set objectFit(t){this.f=t}get needFill(){return!1}get needStroke(){return!1}constructor(t){super(t),this.type=e.B$.Img,t&&this.read(t)}read(t){return super.read(t),_(t.s)&&(this.s=t.s),c(t.f)&&(this.f=t.f),this}}class $ extends S{constructor(t){super(t,F),this._loaded=!1,this._error="",this.onLoad=()=>{this.beginDirty(),this._loaded=!0,this.endDirty()},this.onError=t=>{this.beginDirty(),this._error="fail to load: "+t.target.src,this.endDirty()},this._r=e.cM.All}get img(){const t=this.data;return this._src===t.src||(this._img&&(this._img.removeEventListener("load",this.onLoad),this._img.removeEventListener("error",this.onError)),this._src=t.src,this._loaded=!1,this._error="",this._img=new Image,this._img.src=this.data.src,this._img.addEventListener("load",this.onLoad),this._img.addEventListener("error",this.onError)),this._img}render(t){if(!this.visible)return;const{img:i}=this;if(this._loaded){let{x:s,y:r,w:h,h:o}=this.drawingRect();switch(this.data.objectFit){case e.LX.Fill:this.beginDraw(t),t.drawImage(i,0,0,i.width,i.height,0,0,h,o),this.endDraw(t);break;case e.LX.Contain:{const e=i.width/i.height;let n=s,a=r,d=h,l=o;e>h/o?(l=h/e,a+=.5*(o-l)):(d=o*e,n+=.5*(h-d)),this.beginDraw(t),t.drawImage(i,0,0,i.width,i.height,n-s,a-r,d,l),this.endDraw(t);break}case e.LX.Cover:{const e=i.width/i.height,s=h/o;let r=0,n=0,a=i.width,d=i.height;e<s?(d=a/s,n=(i.height-d)/2):(a=d*s,r=(i.width-a)/2),this.beginDraw(t),t.drawImage(i,r,n,a,d,0,0,h,o),this.endDraw(t);break}}}else this._error?this.drawText(t,"error: "+this._error):this.drawText(t,"loading: "+this.data.src);super.render(t)}drawText(t,e){this.beginDraw(t);const{x:i,y:s,w:r,h:h}=this.drawingRect();t.fillStyle="#FF000088",t.fillRect(i,s,r,h),t.fillStyle="#00000088",t.fillRect(0,0,r,h),t.font="normal 16px serif",t.fillStyle="white";const{fontBoundingBoxDescent:o,fontBoundingBoxAscent:n,actualBoundingBoxLeft:a}=t.measureText(e),d=o+n;t.fillText(e,i+1+a,s+d),this.endDraw(t)}}L.registerShape(e.B$.Img,()=>new F,t=>new $(t)),L.registerTool(e.s8.Img,()=>new B(e.s8.Img,e.B$.Img),{name:"Image",desc:"Image drawer",shape:e.B$.Img});class G extends f{get coords(){return this.u}set coords(t){this.u=t}get needFill(){return!1}constructor(t){super(t),this.u=[],this.type=e.B$.Lines,this.strokeStyle="#ff0000",this.lineCap="round",this.lineJoin="round",this.lineWidth=2,t&&this.read(t)}read(t){super.read(t);const{coords:e}=t,{u:i=e}=t;return Array.isArray(i)&&(this.coords=[...i]),this}merge(t){super.read(t);const{coords:e}=t,{u:i=e}=t;return Array.isArray(i)&&(this.coords=[...i]),this}}class W extends S{constructor(t){let e,i;super(t,G),this._srcGeo=null,this._path2D=new Path2D;for(let s=0;s<this.data.coords.length;s+=2)e=this.data.coords[s],i=this.data.coords[s+1],this.updatePath(e,i,0===s?"first":void 0);this.updateSrcGeo()}merge(t){const e=this.data.copy();this.beginDirty(e);const i=this.data.coords.length;this.data.merge(t);const s=this.data.coords.length-1;if(i!==s){let t,e;for(let r=i;r<=s;r+=2)t=this.data.coords[r],e=this.data.coords[r+1],this.updatePath(t,e,0===r?"first":void 0)}this.updateSrcGeo(),this.endDirty(e)}updateSrcGeo(){let t=Number.MAX_VALUE,e=Number.MAX_VALUE,i=Number.MIN_VALUE,s=Number.MIN_VALUE;for(let r=0;r<this.data.coords.length;r+=2){const h=this.data.coords[r],o=this.data.coords[r+1];t=Math.min(t,h),e=Math.min(e,o),i=Math.max(i,h),s=Math.max(s,o)}return this._srcGeo={x:t,y:e,w:i-t,h:s-e},this._srcGeo}updatePath(t,e,i){"first"===i?this._path2D.moveTo(t,e):this._path2D.lineTo(t,e)}pushDot(t,e){this.data.coords.push(t.x,t.y);const i=this.updateSrcGeo();this.updatePath(t.x,t.y,e),this.geo(i.x,i.y,i.w,i.h),this.endDirty()}editDot(t){this.data.coords[this.data.coords.length-2]=t.x,this.data.coords[this.data.coords.length-1]=t.y,this._path2D=new Path2D;for(let i=0;i<this.data.coords.length;i+=2){const t=this.data.coords[i],e=this.data.coords[i+1];this.updatePath(t,e,0===i?"first":void 0)}const e=this.updateSrcGeo();this.geo(e.x,e.y,e.w,e.h),this.endDirty()}render(t){if(!this.visible)return;const e=this.data;e.lineWidth&&e.strokeStyle&&this._srcGeo&&(t.save(),t.translate(this.data.x-this._srcGeo.x,this.data.y-this._srcGeo.y),t.lineCap=e.lineCap,t.lineDashOffset=e.lineDashOffset||0,t.lineJoin=e.lineJoin,t.lineWidth=e.lineWidth||0,t.miterLimit=e.miterLimit||0,t.strokeStyle=e.strokeStyle,t.setLineDash(e.lineDash),t.stroke(this._path2D),t.restore()),super.render(t)}}L.registerShape(e.B$.Lines,()=>new G,t=>new W(t));class N{constructor(){this._pressingShift=!1,this._pressingControl=!1,this._keydown=t=>{"Shift"===t.key?this._pressingShift=!0:"Control"===t.key&&(this._pressingControl=!0)},this._keyup=t=>{"Shift"===t.key?this._pressingShift=!1:"Control"===t.key&&(this._pressingControl=!1)},this._blur=t=>{this._pressingShift=!1,this._pressingControl=!1}}start(){window.addEventListener("keydown",this._keydown,!0),window.addEventListener("keyup",this._keyup,!0),window.addEventListener("blur",this._blur,!0)}end(){window.removeEventListener("keydown",this._keydown,!0),window.removeEventListener("keyup",this._keyup,!0),window.removeEventListener("blur",this._blur,!0)}get type(){return e.s8.Lines}render(){}get board(){return this._board}set board(t){this._board=t}addDot(t,i){const s=this._curShape,r=this.board;if(!s||!r)return;if(this._prevData)return s.pushDot(t,i);const h=()=>{const t=this._prevData;if(!t)return;const i=s.data.copy();i.coords.splice(0,t.coords.length),r.emitEvent(e._L.ShapesChanging,{operator:r.whoami,shapeType:this.type,shapeDatas:[[i,t]]}),delete this._prevData};this._prevData=s.data.copy();this._prevData.coords.length<=0?(s.pushDot(t,i),h()):(s.pushDot(t,i),setTimeout(h,1e3/30))}moveDot(t){const i=this._curShape,s=this.board;if(!i||!s)return;if(this._pressingControl&&i.data.coords.length>=4){const e=i.data.coords[i.data.coords.length-4],s=i.data.coords[i.data.coords.length-3],r=180*Math.atan2(t.y-s,t.x-e)/Math.PI,h=Math.sqrt((Math.pow(t.x-e,2)+Math.pow(t.y-s,2))/2);r>22.5&&r<=67.5?(t.x=e+h,t.y=s+h):r>67.5&&r<=112.5?t.x=e:r>112.5&&r<=157.5?(t.x=e-h,t.y=s+h):r>157.5||r<=-157.5?t.y=s:r<=-112.5&&r>-157.5?(t.x=e-h,t.y=s-h):r<=-67.5&&r>-112.5?t.x=e:r<=-22.5&&r>-67.5?(t.x=e+h,t.y=s-h):t.y=s}if(this._prevData)return i.editDot(t);const r=()=>{const t=this._prevData;if(!t)return;const r=i.data.copy();r.coords.splice(0,t.coords.length),s.emitEvent(e._L.ShapesChanging,{operator:s.whoami,shapeType:this.type,shapeDatas:[[r,t]]}),delete this._prevData};this._prevData=i.data.copy();this._prevData.coords.length<=0?(i.editDot(t),r()):(i.editDot(t),setTimeout(r,1e3/30))}pointerMove(t){this._curShape&&this.moveDot(t)}pointerDown(t){const i=this.board;i&&(this._curShape||(this._curShape=i.factory.newShape(e.B$.Lines),this._curShape.data.layer=i.layer().id,this._curShape.data.editing=!0,i.add(this._curShape,!0),this.addDot(t,"first"),this.addDot(t)))}pointerDraw(t){this.moveDot(t)}pointerUp(t){var i;const s=this._curShape;s&&(this._pressingShift?this.addDot(t):(s.data.editing=!1,null===(i=this._board)||void 0===i||i.emitEvent(e._L.ShapesDone,{operator:this._board.whoami,shapeDatas:[s.data.copy()]}),delete this._curShape))}}L.registerTool(e.s8.Lines,()=>new N,{name:"Lines",desc:"lines",shape:e.B$.Lines});class H extends f{constructor(t){super(t),this.type=e.B$.Oval,this.strokeStyle="#ff0000",this.lineWidth=2,t&&this.read(t)}}class X extends D{constructor(t){super(t,H)}path(t){const{x:e,y:i,w:s,h:r}=this.drawingRect(),h=s>r?s:r,o={x:s/h,y:r/h};t.save(),t.scale(o.x,o.y),t.beginPath(),t.arc((e+.5*s)/o.x,(i+.5*r)/o.y,h/2,0,2*Math.PI),t.closePath(),t.restore()}}L.registerShape(e.B$.Oval,()=>new H,t=>new X(t));class Y extends B{constructor(){super(e.s8.Oval,e.B$.Oval)}applyRect(){var t;if(!this.holdingKey("Shift","Alt"))return this.holdingKey("Shift")||this.holdingKey("Alt"),super.applyRect();{const e=this._rect.from,i=this._rect.to,s=Math.sqrt(Math.pow(e.y-i.y,2)+Math.pow(e.x-i.x,2)),r=e.x-s,h=e.y-s;null===(t=this._curShape)||void 0===t||t.geo(r,h,2*s,2*s)}}}L.registerTool(e.s8.Oval,()=>new Y,{name:"Oval",desc:"oval drawer",shape:e.B$.Oval}),e.JQ=void 0,(O=e.JQ||(e.JQ={}))[O.Invalid=0]="Invalid",O[O.All=1]="All",O[O.Append=2]="Append",O[O.Subtract=3]="Subtract";class V extends f{get dotsType(){return this.v}set dotsType(t){this.v=t}get coords(){return this.u}set coords(t){this.u=t}get needFill(){return!1}constructor(t){super(t),this.v=e.JQ.All,this.u=[],this.type=e.B$.Pen,this.strokeStyle="#ff0000",this.lineCap="round",this.lineJoin="round",this.lineWidth=3,t&&this.read(t)}read(t){super.read(t);const{u:e=t.coords,v:i=t.dotsType}=t;return i&&(this.dotsType=i),Array.isArray(e)&&(this.coords=[...e]),this}merge(t){super.read(t);const{u:i=t.coords}=t;if(!Array.isArray(i))return this;switch(t.dotsType){case e.JQ.Subtract:this.coords=this.coords.slice(0,-i.length);break;case e.JQ.Append:this.coords.push(...i);break;default:this.coords=[...i]}return this}}class j extends S{constructor(t){let e,i;super(t,V),this._lineFactor=.5,this._smoothFactor=.5,this._srcGeo=null,this._path2D=new Path2D;for(let s=0;s<this.data.coords.length;s+=2)e=this.data.coords[s],i=this.data.coords[s+1],this.updateSrcGeo(e,i),0===s?this.updatePath(e,i,"first"):s>=this.data.coords.length-2?this.updatePath(e,i,"last"):this.updatePath(e,i)}merge(t){const e=this.data.copy();this.beginDirty(e);const i=this.data.coords.length;this.data.merge(t);const s=this.data.coords.length-1;if(i!==s){let t,e;for(let r=i;r<=s;r+=2)t=this.data.coords[r],e=this.data.coords[r+1],this.updateSrcGeo(t,e),0===r?this.updatePath(t,e,"first"):this.data.editing||r!==s?this.updatePath(t,e):this.updatePath(t,e,"last")}this.endDirty(e)}updateSrcGeo(t,e){if(this._srcGeo){const i=Math.min(this._srcGeo.x,t),s=Math.min(this._srcGeo.y,e);let r=Math.max(this._srcGeo.x+this._srcGeo.w,t)-i,h=Math.max(this._srcGeo.y+this._srcGeo.h,e)-s;r!==r&&(r=0),h!==h&&(h=0),this._srcGeo={x:i,y:s,w:r,h:h}}else this._srcGeo={x:t,y:e,w:0,h:0};return this._srcGeo}updatePath(t,e,i){if(void 0===this.prev_dot&&(this.prev_dot={x:t,y:e},this._path2D.moveTo(t,e)),"first"===i)return;const{x:s,y:r}=this.prev_dot;void 0===this.prev_t&&(this.prev_t={x:t-(t-s)*this._lineFactor,y:e-(e-r)*this._lineFactor},this._path2D.lineTo(this.prev_t.x,this.prev_t.y));const{x:h,y:o}=this.prev_t,n=s+(t-s)*this._lineFactor,a=r+(e-r)*this._lineFactor,d=t-(t-s)*this._lineFactor,l=e-(e-r)*this._lineFactor,c=h+(s-h)*this._smoothFactor,_=o+(r-o)*this._smoothFactor,u=s+(n-s)*(1-this._smoothFactor),p=r+(a-r)*(1-this._smoothFactor);this._path2D.bezierCurveTo(c,_,u,p,n,a),"last"===i?(delete this.prev_t,delete this.prev_dot,this._path2D.lineTo(t,e)):(this.prev_t={x:d,y:l},this.prev_dot={x:t,y:e})}appendDot(t,e){const i=this.data.coords,s=i[i.length-1],r=i[i.length-2];if(s===t.y&&r===t.x&&"last"!==e)return;this.data.coords.push(t.x,t.y);const h=this.updateSrcGeo(t.x,t.y);this.updatePath(t.x,t.y,e),this.geo(h.x,h.y,h.w,h.h),this.endDirty()}render(t){if(!this.visible)return;const e=this.data;e.lineWidth&&e.strokeStyle&&this._srcGeo&&(this.beginDraw(t),t.translate(-this._srcGeo.x,-this._srcGeo.y),t.lineCap=e.lineCap,t.lineDashOffset=e.lineDashOffset||0,t.lineJoin=e.lineJoin,t.lineWidth=e.lineWidth||0,t.miterLimit=e.miterLimit||0,t.strokeStyle=e.strokeStyle,t.setLineDash(e.lineDash),t.stroke(this._path2D),this.endDraw(t)),super.render(t)}}L.registerShape(e.B$.Pen,()=>new V,t=>new j(t));class J{constructor(){this.type=e.s8.Pen,this.board=void 0}end(){var t;const i=this._curShape;if(i&&i.data.coords.length>=2){const{coords:s}=i.data;i.data.editing=!1,this.addDot({x:s[s.length-2],y:s[s.length-1],p:0},"last"),null===(t=this.board)||void 0===t||t.emitEvent(e._L.ShapesDone,{operator:this.board.whoami,shapeDatas:[i.data.copy()]})}delete this._curShape}pointerDown(t){const i=this.board;i&&(this._curShape=i.factory.newShape(e.B$.Pen),this._curShape.data.layer=i.layer().id,this._curShape.data.editing=!0,i.add(this._curShape,!0),this.addDot(t,"first"))}pointerDraw(t){this.addDot(t)}pointerUp(t){var i;const s=this._curShape;s&&(s.data.editing=!1,this.addDot(t,"last"),null===(i=this.board)||void 0===i||i.emitEvent(e._L.ShapesDone,{operator:this.board.whoami,shapeDatas:[s.data.copy()]}),delete this._curShape)}addDot(t,i){const s=this._curShape,r=this.board;if(!s||!r)return;if(this._prevData)return s.appendDot(t,i);const h=()=>{const t=this._prevData;if(!t)return;const i=s.data.copy();i.dotsType=e.JQ.Append,i.coords.splice(0,t.coords.length),r.emitEvent(e._L.ShapesChanging,{operator:r.whoami,shapeType:this.type,shapeDatas:[[i,t]]}),delete this._prevData};this._prevData=s.data.copy();this._prevData.coords.length<=0?(s.appendDot(t,i),h()):(s.appendDot(t,i),setTimeout(h,1e3/30))}}L.registerTool(e.s8.Pen,()=>new J,{name:"Pen",desc:"simple pen",shape:e.B$.Pen});class q extends f{constructor(t){super(t),this.u=[],this.type=e.B$.Polygon,this.fillStyle="#ff0000",this.strokeStyle="#000000",this.lineWidth=2,t&&this.read(t)}get dots(){return this.u}set dots(t){this.u=t}read(t){super.read(t);const{u:e=t.dots}=t;return e&&(this.u=e.map(t=>Object.assign({},t))),this}}class U extends D{constructor(t){super(t,q)}path(t){const{x:e,y:i,w:s,h:r}=this.drawingRect();t.beginPath(),t.rect(e,i,s,r),t.closePath()}}L.registerShape(e.B$.Polygon,()=>new q,t=>new U(t));const K={name:"Polygon",desc:"Polygon Drawer",shape:e.B$.Polygon};L.registerTool(e.s8.Polygon,()=>new B(e.s8.Polygon,e.B$.Polygon),K);class Q extends f{constructor(t){super(t),this.type=e.B$.Rect,this.strokeStyle="#ff0000",this.lineWidth=2,t&&this.read(t)}}class Z extends D{constructor(t){super(t,Q)}path(t){const{x:e,y:i,w:s,h:r}=this.drawingRect();t.beginPath(),t.rect(e,i,s,r),t.closePath()}}L.registerShape(e.B$.Rect,()=>new Q,t=>new Z(t)),L.registerTool(e.s8.Rect,()=>new B(e.s8.Rect,e.B$.Rect),{name:"Rectangle",desc:"rect drawer",shape:e.B$.Rect});class tt extends f{constructor(t){super(t),this.s="",this.u=["normal","normal","normal",24,"Simsum"],this.m=3,this.n=3,this.p=3,this.q=3,this.type=e.B$.Text,this.fillStyle="#ff0000",this.strokeStyle="",this.lineWidth=0,t&&this.read(t)}get text(){return this.s}set text(t){this.s=t}get f_d(){return this.u}set f_d(t){this.u=t}get t_l(){return this.m}set t_l(t){this.m=t}get t_r(){return this.n}set t_r(t){this.n=t}get t_t(){return this.p}set t_t(t){this.p=t}get t_b(){return this.q}set t_b(t){this.q=t}get font(){const t=[...this.f_d];return t[3]=`${t[3]}px`,t.join(" ")}get font_style(){return this.f_d[0]}get font_variant(){return this.f_d[1]}get font_weight(){return this.f_d[2]}get font_size(){return this.f_d[3]}get font_family(){return this.f_d[4]}set font_style(t){this.f_d[0]=t}set font_variant(t){this.f_d[1]=t}set font_weight(t){this.f_d[2]=t}set font_size(t){this.f_d[3]=t}set font_family(t){this.f_d[4]=t}read(t){super.read(t);const{s:e=t.text,u:i=t.f_d,m:s=t.t_l,n:r=t.t_r,p:h=t.t_t,q:o=t.t_b}=t;return _(e)&&(this.s=e),Array.isArray(i)&&(this.u=[...i]),c(s)&&(this.m=s),c(r)&&(this.n=r),c(h)&&(this.p=h),c(o)&&(this.q=o),this}}class et{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;this.start=-1,this.end=-1,this.start=t,this.end=e}equal(t){return this.start===t.start&&this.end===t.end}}const it=document.createElement("canvas").getContext("2d");class st extends S{get text(){return this.data.s}set text(t){this.setText(t)}get selection(){return this._selection}set selection(t){this.setSelection(t)}get selectionRects(){return this._selectionRects}get offscreen(){return this._offscreen=this._offscreen||document.createElement("canvas"),this._offscreen}constructor(t){super(t,tt),this._selection=new et,this._lines=[],this._selectionRects=[],this._cursorVisible=!1,this._calculateLines(),this._calculateSectionRects()}get fontSize(){return this.data.font_size}set fontSize(t){const e={};this.beginDirty(e),this.data.font_size=t,this._calculateLines(),this._calculateSectionRects(),this.endDirty(e)}merge(t){const e=this.data.copy();this.beginDirty(e),this.data.merge(t),this._calculateLines(),this._calculateSectionRects(),this.endDirty(e)}_setCursorVisible(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!this._cursorVisible;this._cursorVisible=t,this.endDirty()}_setCursorFlashing(t){t&&(this._cursorVisible=!0),t!==!!this._cursorFlashingTimer&&(clearInterval(this._cursorFlashingTimer),delete this._cursorFlashingTimer,t?this._cursorFlashingTimer=setInterval(()=>this._setCursorVisible(),500):this._setCursorVisible(!0))}_applyStyle(t){t&&(t.font=this.data.font,t.fillStyle=this.data.fillStyle,t.strokeStyle=this.data.strokeStyle,t.lineWidth=this.data.lineWidth,t.setLineDash([]))}setText(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.data.s!==t&&(this.data.s=t,this._calculateLines(),e&&this.endDirty())}setSelection(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{start:-1,end:-1},e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._selection.equal(t)||(this._selection.start=t.start,this._selection.end=t.end,this._setCursorFlashing(t.start===t.end&&t.start>=0),this._calculateSectionRects(),e&&this.endDirty())}_calculateLines(){this._applyStyle(it);let t=this.data.p,e=0;const i=this.text;this._lines=i.split("\n").map(i=>{const s=i+"\n",r=it.measureText(s),h=t,o=h+r.fontBoundingBoxAscent;return e=Math.max(r.width,e),t+=r.fontBoundingBoxAscent+r.fontBoundingBoxDescent,Object.assign({str:s,x:this.data.m,y:h,bl:o},r)}),t+=this.data.q,e+=this.data.n+this.data.m,this.resize(e,t)}_calculateSectionRects(){this._applyStyle(it);const t=this._selection;let e=0,i=0;this._selectionRects=[];for(let s=0;s<this._lines.length;++s){const{str:r,y:h,x:o}=this._lines[s];if(i+=r.length,i<=t.start){e=i;continue}if(e>t.end)break;const a=r.substring(0,t.start-e),d=r.substring(t.start-e,t.end-e),l=it.measureText(a),c=it.measureText(d),_=o+l.width,u=h,p=c.fontBoundingBoxAscent+c.fontBoundingBoxDescent;this._selectionRects.push(new n(_,u,Math.max(2,c.width),p)),e=i}}render(t){if(!this.visible)return;const e=this.data.strokeStyle&&this.data.lineWidth,i=this.data.fillStyle;if(!this.editing&&!e&&!i)return super.render(t);if(this.beginDraw(t),this.editing){const{x:e,y:i,w:s,h:r}=this.drawingRect();let h=1,o=h/2;t.lineWidth=h,t.strokeStyle=this.data.fillStyle||"white",t.setLineDash([]),t.strokeRect(e+o,i+o,s-h,r-h)}if(e||i){const{x:s,y:r,w:h,h:o}=this.drawingRect(),{offscreen:n}=this;n.width=h,n.height=o;const a=n.getContext("2d");this._applyStyle(a),a.globalCompositeOperation="source-over";for(let t=0;t<this._lines.length;++t){const s=this._lines[t];i&&a.fillText(s.str,s.x,s.bl),e&&a.strokeText(s.str,s.x,s.bl)}if(this._cursorVisible&&this.editing){a.globalCompositeOperation="xor",a.fillStyle=this._cursorFlashingTimer?this.data.fillStyle:"#2f71ff";for(let e=0;e<this._selectionRects.length;++e){const i=this._selectionRects[e];t.fillStyle="white",t.fillRect(s+i.x,r+i.y,i.w,i.h),a.fillRect(i.x,i.y,i.w,i.h)}}t.drawImage(n,s,r)}return this.endDraw(t),super.render(t)}}L.registerShape(e.B$.Text,()=>new tt,t=>new st(t));var rt="writeboard_layer_onscreen_canvas_kWJIP",ht="writeboard_text_editor_nWT80";class ot{set curShape(t){var i;const s=this._curShape;if(s!==t){if(this._curShape=t,t?(t.editing=!0,this._updateEditorStyle(t),this.editor.style.display="block",this.editor.value=t.text):this.editor.style.display="none",s)if(s.editing=!1,s.text||this._newTxt)this._newTxt&&(this._newTxt=!1,null===(i=this._board)||void 0===i||i.emitEvent(e._L.ShapesDone,{operator:this._board.whoami,shapeDatas:[s.data.copy()]}));else{const t=this.board;if(!t)return;s.merge(this._prevData),t.remove(s,!0)}this._prevData=null===t||void 0===t?void 0:t.data.copy()}}constructor(){this.type=e.s8.Text,this.editor=document.createElement("textarea"),this._newTxt=!1,this._updateEditorStyle=t=>{const{board:e}=this;e&&(this.editor.style.font=t.data.font,this.editor.style.left=e.world.x+t.data.x+"px",this.editor.style.top=e.world.y+t.data.y+"px",this.editor.style.minWidth=t.data.w+"px",this.editor.style.minHeight=t.data.h+"px",this.editor.style.maxWidth=t.data.w+"px",this.editor.style.maxHeight=t.data.h+"px",this.editor.style.paddingLeft=t.data.t_l+"px",this.editor.style.paddingTop=t.data.t_t+"px",this.editor.style.transform=`rotate(${(180*t.data.rotation/Math.PI).toFixed(4)}deg) scale(${t.data.scaleX},${t.data.scaleY})`)},this._updateShapeText=()=>{const t=this._curShape;if(!t)return;const i=t.data.copy();t.setText(this.editor.value,!1),t.setSelection({start:this.editor.selectionStart,end:this.editor.selectionEnd}),this._updateEditorStyle(t);const s=this.board;if(!s)return;const r=t.data.copy();s.emitEvent(e._L.ShapesChanging,{operator:s.whoami,shapeType:this.type,shapeDatas:[[r,i]]})},this._docPointerdown=t=>{this.curShape=void 0},this._keydown=t=>{(t.ctrlKey&&"Enter"===t.key||"Escape"===t.key)&&(this.curShape=void 0),t.stopPropagation()},this.editor.wrap="off",this.editor.classList.add(ht)}start(){this.editor.addEventListener("keydown",this._keydown),this.editor.addEventListener("input",this._updateShapeText),document.addEventListener("selectionchange",this._updateShapeText),document.addEventListener("pointerdown",this._docPointerdown)}end(){this.editor.removeEventListener("keydown",this._keydown),this.editor.removeEventListener("input",this._updateShapeText),document.removeEventListener("selectionchange",this._updateShapeText),document.removeEventListener("pointerdown",this._docPointerdown),this.curShape=void 0}get board(){return this._board}set board(t){var e,i,s;this._board=t,null===(s=null===(i=null===(e=this._board)||void 0===e?void 0:e.onscreen())||void 0===i?void 0:i.parentElement)||void 0===s||s.appendChild(this.editor)}pointerDown(t){const{board:i}=this;if(!i)return;let s;const r=i.hits(Object.assign(Object.assign({},t),{w:0,h:0}));for(let h=0;h<r.length;++h){if(r[h].data.type===e.B$.Text){s=r[h];break}}if(s||!this._curShape){if(!s){this._newTxt=!0;const r=i.factory.newShape(e.B$.Text);r.data.layer=i.layer().id,r.move(t.x,t.y),i.add(r,!0),s=r}this.connect(s)}else this.curShape=void 0}connect(t){const{board:e}=this;e&&(this.curShape=t,setTimeout(()=>this.editor.focus(),10))}}L.registerTool(e.s8.Text,()=>new ot,{name:"Text",desc:"enter some text",shape:e.B$.Text});class nt extends f{get needFill(){return!1}constructor(t){super(t),this.type=e.B$.Tick,this.strokeStyle="#FF0000",this.lineWidth=2,t&&this.read(t)}}class at extends D{constructor(t){super(t,nt)}path(t){const{x:e,y:i,w:s,h:r}=this.drawingRect(),h={x:e,y:i+.7*r},o={x:e+s/3,y:i+r},n={x:e+s,y:i};t.beginPath(),t.moveTo(h.x,h.y),t.bezierCurveTo(h.x+(o.x-h.x)/3,h.y,o.x,o.y-(o.y-h.y)/3,o.x,o.y),t.bezierCurveTo(o.x,o.y-(o.y-n.y)/3,n.x-(n.x-o.x)/4,n.y,n.x,n.y)}}L.registerShape(e.B$.Tick,()=>new nt,t=>new at(t)),L.registerTool(e.s8.Tick,()=>new B(e.s8.Tick,e.B$.Tick),{name:"Tick",desc:"tick drawer",shape:e.B$.Tick});class dt{constructor(t){this.id=t.id,this.name=t.name}}class lt{get name(){return this._info.name}get info(){return this._info}get onscreen(){return this._onscreen}get offscreen(){return this._offscreen}get ctx(){return this._ctx}get octx(){return this._octx}get opacity(){return Number(this._offscreen.style.opacity)}set opacity(t){this._onscreen.style.opacity=""+t}get id(){return this._info.id}constructor(t){var e;this._own_onscreen=!1,this._own_offscreen=!1,this._info=new dt(t.info),this._onscreen=null!==(e=t.onscreen)&&void 0!==e?e:document.createElement("canvas"),this._own_onscreen=!t.onscreen,this._onscreen.setAttribute("layer_id",this.id),this._onscreen.setAttribute("layer_name",this.name),this._onscreen.draggable=!1,this._onscreen.classList.add(rt),this._ctx=this._onscreen.getContext("2d"),this._offscreen=document.createElement("canvas"),this._own_offscreen=!0,this._offscreen.width=this._onscreen.width,this._offscreen.height=this._onscreen.height,this._octx=this._offscreen.getContext("2d")}get width(){return this._onscreen.width}set width(t){this._onscreen.width=t,this._offscreen.width=t}get height(){return this._onscreen.height}set height(t){this._onscreen.height=t,this._offscreen.height=t}destory(){this._own_onscreen&&this._onscreen.remove(),this._own_offscreen&&this._offscreen.remove()}}class ct{get lb_down(){return!!this._mousebuttons[0]}get mb_down(){return!!this._mousebuttons[1]}get viewport(){return this._viewport}get world(){return this._world}get whoami(){return this._whoami}get width(){return this._viewport.w}set width(t){this._viewport.w=t,this._layers.forEach(e=>e.width=t),this.markViewDirty()}get height(){return this._viewport.h}set height(t){this._viewport.h=t,this._layers.forEach(e=>e.height=t),this.markViewDirty()}scroll_to(t,e){const{min:i,max:s}=Math;return this._world.x=-s(i(t,this._world.w-this._viewport.w),0),this._world.y=-s(i(e,this._world.h-this._viewport.h),0),this.markViewDirty(),this}scroll_by(t,e){return this.scroll_to(-this.world.x+t,-this.world.y+e)}addLayer(t){return t?this._layers.has(t.info.id)?(console.error(`[WhiteBoard] addLayer(): layerId already existed! id = ${t.info.id}`),!1):(t instanceof lt?(t.width=this.width,t.height=this.height,t.onscreen.style.pointerEvents="none",this._element.appendChild(t.onscreen),this._layers.set(t.info.id,t),this.dispatchEvent(new CustomEvent(e._L.LayerAdded,{detail:t})),this.markViewDirty()):(t=this.factory.newLayer(t),this.addLayer(t)),!0):(t=this.factory.newLayer(),this.addLayer(t),!0)}markViewDirty(){return this.markDirty({x:-this.world.x,y:-this.world.y,w:this.viewport.w,h:this.viewport.h}),this}removeLayer(t){const i=this._layers.get(t);return i?(this._layers.delete(t),this._element.removeChild(i.onscreen),this.dispatchEvent(new CustomEvent(e._L.LayerRemoved,{detail:i})),!0):(console.error(`[WhiteBoard] removeLayer(): layer not found! id = ${t}`),!1)}editLayer(t){return this._layers.has(t)?(this._layers.forEach((e,i)=>{e.onscreen.style.pointerEvents=i===t?"":"none"}),this._editingLayerId=t,!0):(console.error(`[WhiteBoard] editLayer(): layer not found! id = ${t}`),!1)}layer(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._editingLayerId;return this._layers.get(t)}addLayers(t){t.length&&(t.forEach(t=>this.addLayer(t)),this.editLayer(t[0].info.id))}get layers(){return Array.from(this._layers.values())}get element(){return this._element}constructor(t,e){var i,s;this._toolType=void 0,this._layers=new Map,this._mousebuttons={},this._tools=new Map,this._selects=[],this._own_element=!1,this._whoami="local",this._editingLayerId="",this._viewport=new n(0,0,600,600),this._world=new n(0,0,1600,1600),this._world_drag_start_pos={x:0,y:0},this._wheel=t=>{const e=t.shiftKey?t.deltaY:0,i=t.shiftKey?0:t.deltaY;this.world_rect_changing(()=>{this.scroll_by(e,i)})},this._pointerdown=t=>{var e,i;if(this._mousebuttons[t.button]=1,0===t.button){if(!this.tool)return void console.warn("toolType not set.");null===(i=null===(e=this.tool)||void 0===e?void 0:e.pointerDown)||void 0===i||i.call(e,this.getDot(t)),t.stopPropagation()}else 1===t.button?(this._world_drag_start_pos={x:-this._world.x+t.x,y:-this._world.y+t.y},t.stopPropagation()):(t.preventDefault(),t.stopPropagation())},this._pointermove=t=>{var e,i,s,r;this.mb_down&&this.world_rect_changing(()=>{const{x:e,y:i}=this._world_drag_start_pos;this.scroll_to(e-t.x,i-t.y)}),this.lb_down?null===(i=null===(e=this.tool)||void 0===e?void 0:e.pointerDraw)||void 0===i||i.call(e,this.getDot(t)):null===(r=null===(s=this.tool)||void 0===s?void 0:s.pointerMove)||void 0===r||r.call(s,this.getDot(t)),t.stopPropagation()},this._pointerup=t=>{var e,i;0==t.button&&(null===(i=null===(e=this.tool)||void 0===e?void 0:e.pointerUp)||void 0===i||i.call(e,this.getDot(t)),t.stopPropagation()),this._mousebuttons[t.button]=0},this._factory=t,this._shapesMgr=this._factory.newShapesMgr(),this._element=null!==(i=e.element)&&void 0!==i?i:document.createElement("div"),this._own_element=!e.element;const{width:r=this._viewport.w,scrollWidth:h=r,height:o=this._viewport.h,scrollHeight:a=o,toolType:d=this._toolType}=e;this._viewport.w=r,this._world.w=h,this._viewport.h=o,this._world.h=a,this._toolType=d;const l=null!==(s=e.layers)&&void 0!==s?s:[];l.length||l.push({info:{id:t.newLayerId(),name:t.newLayerName()}}),this.addLayers(l),this._element.addEventListener("pointerdown",this._pointerdown),this._element.addEventListener("wheel",this._wheel),this._element.tabIndex=0,this._element.style.outline="none",window.addEventListener("pointermove",this._pointermove),window.addEventListener("pointerup",this._pointerup)}find(t){return this._shapesMgr.find(t)}toSnapshot(){return{v:0,x:0,y:0,w:this.width,h:this.height,l:Array.from(this._layers.values()).map(t=>t.info),s:this.shapes().map(t=>t.data.wash())}}fromSnapshot(t){this.removeAll(!1),Array.from(this._layers.keys()).forEach(t=>this.removeLayer(t)),this.addLayers(t.l.map(t=>({info:t})));const e=t.s.map(t=>this.factory.newShape(t));this.add(e,!1)}toJson(t,e){return JSON.stringify(this.toSnapshot(),t,e)}fromJson(t){this.fromSnapshot(JSON.parse(t))}shapes(){return this._shapesMgr.shapes()}exists(){return this._shapesMgr.exists(...arguments)}hit(t){return this._shapesMgr.hit(t)}hits(t){return this._shapesMgr.hits(t)}addEventListener(t,e,i){return this._element.addEventListener(t,e,i)}removeEventListener(t,e,i){return this._element.removeEventListener(t,e,i)}dispatchEvent(t){return this._element.dispatchEvent(t)}emitEvent(t,e){return this.dispatchEvent(new CustomEvent(t,{detail:e}))}get factory(){return this._factory}set factory(t){this._factory=t}ctx(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._editingLayerId;var e;return null===(e=this.onscreen(t))||void 0===e?void 0:e.getContext("2d")}octx(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._editingLayerId;var e;return null===(e=this.offscreen(t))||void 0===e?void 0:e.getContext("2d")}onscreen(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._editingLayerId;var e;return null===(e=this.layer(t))||void 0===e?void 0:e.onscreen}offscreen(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._editingLayerId;var e;return null===(e=this.layer(t))||void 0===e?void 0:e.offscreen}get toolType(){return this._toolType}set toolType(t){this.setToolType(t)}setToolType(t){var i,s,r,h;if(this._toolType===t)return void(this._tool instanceof ot&&this._tool.selectorCallback&&this._tool.editor.removeEventListener("blur",this._tool.selectorCallback));const o=this._toolType;this._toolType=t,this.emitEvent(e._L.ToolChanged,{operator:this._whoami,from:o,to:t}),null===(s=null===(i=this._tool)||void 0===i?void 0:i.end)||void 0===s||s.call(i),t&&(this._tool=this._factory.newTool(t),this._tool?(this._tool.board=this,this._tools.set(t,this._tool),null===(h=(r=this._tool).start)||void 0===h||h.call(r)):console.error("toolType not supported. got ",t))}get selects(){return this._selects}add(t){let i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const s="boolean"===typeof i?i:!1!==i.emit,r="boolean"===typeof i?this._whoami:i.operator;if(!(t=Array.isArray(t)?t:[t]).length)return 0;const h=this._shapesMgr.add(...t);return t.forEach(t=>{t.board=this,t.selected&&this._selects.push(t),this.markDirty(t.boundingRect())}),s&&this.emitEvent(e._L.ShapesAdded,{operator:r,shapeDatas:t.map(t=>t.data.copy())}),h}remove(t,i){var s;const r=!!i,h=null!==(s=null===i||void 0===i?void 0:i.operator)&&void 0!==s?s:this._whoami;if(!(t=Array.isArray(t)?t:[t]).length)return 0;const o=t.filter(t=>!this.selects.find(e=>t===e));if(this.setSelects(o,r),r){const i=t.map(t=>t.data);i.length&&this.emitEvent(e._L.ShapesRemoved,{operator:h,shapeDatas:i})}const n=this._shapesMgr.remove(...t);return t.forEach(t=>{this.markDirty(t.boundingRect()),t.board=void 0}),n}removeAll(t){return this.remove(this._shapesMgr.shapes(),t)}removeSelected(t){this.remove(this._selects.filter(t=>!t.locked),t),this._selects=[]}selectAll(t){return this.setSelects([...this.shapes()],t)[0]}deselect(t){return this.setSelects([],t)[1]}selectAt(t,e){const i=this._shapesMgr.hits(t);return this.setSelects(i,e)}setSelects(t,i){var s;const r=!!i,h=null!==(s=null===i||void 0===i?void 0:i.operator)&&void 0!==s?s:this._whoami,o=t.filter(t=>!t.selected),n=this._selects.filter(e=>!t.find(t=>e===t));return n.forEach(t=>t.selected=!1),o.forEach(t=>t.selected=!0),this._selects=t,r&&(o.length&&this.emitEvent(e._L.ShapesSelected,{operator:h,shapeDatas:o.map(t=>t.data)}),n.length&&this.emitEvent(e._L.ShapesDeselected,{operator:h,shapeDatas:n.map(t=>t.data)})),[o,n]}getDot(t){const e=this.layer().onscreen,{width:i,height:s,left:r,top:h}=e.getBoundingClientRect(),o=e.width/i,n=e.height/s,{pressure:a=.5}=t;return{x:Math.floor(o*(t.clientX-r-this._world.x)),y:Math.floor(n*(t.clientY-h-this._world.y)),p:a}}get tools(){return this._tools}get tool(){return this._tool}world_rect_changing(t){const i=this._world.pure();t();const s=this._world.pure();return i.x===s.x&&i.y===s.y&&i.w===s.w&&i.h===s.h||this.emitEvent(e._L.WorldRectChanged,{form:i,to:s}),this}markDirty(t){const e=!this._dirty;this._dirty=this._dirty?n.bounds(this._dirty,t):t,e&&requestAnimationFrame(()=>this.render())}render(){var t,e;const i=this._dirty;i&&(this._layers.forEach(t=>{const{octx:e}=t;e.save(),e.translate(this._viewport.x+this._world.x,this._viewport.y+this._world.y),e.clearRect(i.x,i.y,i.w,i.h)}),this._shapesMgr.shapes().forEach(t=>{const e=t.boundingRect();if(!n.hit(e,i))return;const s=this._layers.get(t.data.layer||"");s&&t.render(s.octx)}),null===(e=null===(t=this.tool)||void 0===t?void 0:t.render)||void 0===e||e.call(t,this.layer().octx),this._layers.forEach(t=>{const{ctx:e,octx:s,offscreen:r}=t;e.save();const h=this._viewport.x+this._world.x,o=this._viewport.y+this._world.y;e.translate(h,o),e.clearRect(i.x,i.y,i.w,i.h),e.drawImage(r,i.x+h,i.y+o,i.w,i.h,i.x,i.y,i.w,i.h),e.restore(),s.restore()}),delete this._dirty)}destory(){this._element.removeEventListener("pointerdown",this._pointerdown),this._element.removeEventListener("wheel",this._wheel),window.removeEventListener("pointermove",this._pointermove),window.removeEventListener("pointerup",this._pointerup),this._layers.forEach(t=>t.destory()),this._own_element&&this._element.remove()}}class _t{dashSroke(t,e){t.strokeStyle="white",t.setLineDash([]),t.stroke(),t.strokeStyle="black",t.setLineDash(e),t.stroke()}locked(t,e){e.lineWidth=2;let{x:i,y:s,w:r,h:h}=t.selectorRect();e.beginPath(),e.rect(i,s,r,h),e.closePath(),this.dashSroke(e,[16])}selected(t,e){e.lineWidth=1;let{x:i,y:s,w:r,h:h}=t.selectorRect();e.beginPath(),e.rect(i,s,r,h),e.closePath(),this.dashSroke(e,[4])}resizable(t,i){let{x:s,y:r,w:h,h:o}=t.selectorRect();i.fillStyle="white",i.setLineDash([]);const{s:n,lx:a,rx:d,ty:l,by:c,mx:_,my:u}=t.getResizerNumbers(s,r,h,o),{resizable:p}=t;p&e.cM.Vertical&&(i.beginPath(),i.rect(_,l,n,n),i.fill(),i.stroke(),i.beginPath(),i.rect(_,c,n,n),i.fill(),i.stroke()),p&e.cM.Horizontal&&(i.beginPath(),i.rect(a,u,n,n),i.fill(),i.stroke(),i.beginPath(),i.rect(d,u,n,n),i.fill(),i.stroke()),p&e.cM.Corner&&(i.beginPath(),i.rect(a,l,n,n),i.fill(),i.stroke(),i.beginPath(),i.rect(d,l,n,n),i.fill(),i.stroke(),i.beginPath(),i.rect(a,c,n,n),i.fill(),i.stroke(),i.beginPath(),i.rect(d,c,n,n),i.fill(),i.stroke())}}function ut(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"===typeof Object.getOwnPropertySymbols){var r=0;for(s=Object.getOwnPropertySymbols(t);r<s.length;r++)e.indexOf(s[r])<0&&Object.prototype.propertyIsEnumerable.call(t,s[r])&&(i[s[r]]=t[s[r]])}return i}"function"===typeof SuppressedError&&SuppressedError;class pt{constructor(){this._items=[],this._kvs={}}find(t){return this._kvs[t]||null}shapes(){return this._items}exists(){let t=0;for(var e=arguments.length,i=new Array(e),s=0;s<e;s++)i[s]=arguments[s];return i.forEach(e=>{this._kvs[e.data.id]&&++t}),t}add(){let t=0;for(var e=arguments.length,i=new Array(e),s=0;s<e;s++)i[s]=arguments[s];return i.forEach(e=>{if(this.exists(e))return console.warn("[DefaultShapesMgr]",`can not add "${e.data.id}", already exists!`);this._kvs[e.data.id]=e,this._items.push(e),++t}),this._items.sort((t,e)=>t.data.z-e.data.z),t}remove(){let t=0;for(var e=arguments.length,i=new Array(e),s=0;s<e;s++)i[s]=arguments[s];return i.forEach(e=>{const i=this._items.findIndex(t=>t===e);i<0||(this._items=this._items.filter((t,e)=>e!==i),delete this._kvs[e.data.id],++t)}),t}hits(t){const e=[];for(let i=this._items.length-1;i>=0;--i){const s=this._items[i];!s.ghost&&l.hit(s.data,t)&&e.push(s)}return e}hit(t){for(let e=this._items.length-1;e>=0;--e){const i=this._items[e];if(!i.ghost&&l.hit(i.data,t))return i}return null}}const gt=t=>console.warn("[InvalidTool]",t);class yt{start(){gt("start")}end(){gt("end")}get type(){return""}get board(){gt("get board")}set board(t){gt("set board")}pointerMove(){gt("pointerMove")}pointerDown(){gt("pointerDown")}pointerDraw(){gt("pointerDraw")}pointerUp(){gt("pointerUp")}render(){gt("render")}}var mt;e.kD=void 0,(mt=e.kD||(e.kD={}))[mt.Invalid=0]="Invalid",mt[mt.Default=1]="Default";const ft=u("FactoryEnum",e.kD);e.IX=void 0,(e.IX||(e.IX={})).check=function(t){const e="arial",i=document.createElement("canvas"),s=i.getContext("2d",{willReadFrequently:!0});i.width=64,i.height=64,s.textAlign="center",s.fillStyle="black",s.textBaseline="middle";const r=function(t){return s.clearRect(0,0,64,64),s.font="64px "+t+", "+e,s.fillText("a\u554a",32,32),s.getImageData(0,0,64,64).data.filter(t=>0!=t).join("")};return t.filter(t=>"string"===typeof t&&(t.toLowerCase()===e.toLowerCase()||r(e)!==r(t)))};const vt=["SimSun","SimHei","Microsoft Yahei","Microsoft JhengHei","KaiTi","NSimSun","FangSong","PingFang SC","STHeiti","STKaiti","STSong","STFangsong","STZhongsong","STHupo","STXinwei","STLiti","STXingkai","Hiragino Sans GB","Lantinghei SC","Hanzipen SC","Hannotate SC","Songti SC","Wawati SC","Weibei SC","Xingkai SC","Yapi SC","Yuanti SC","YouYuan","LiSu","STXihei","STKaiti","STSong","STFangsong","STZhongsong","STCaiyun","STHupo","STXinwei","STLiti","STXingkai","FZShuTi","FZYaoti"],wt={SimSun:"\u5b8b\u4f53",SimHei:"\u9ed1\u4f53","Microsoft Yahei":"\u5fae\u8f6f\u96c5\u9ed1","Microsoft JhengHei":"\u5fae\u8f6f\u6b63\u9ed1\u4f53",KaiTi:"\u6977\u4f53",NSimSun:"\u65b0\u5b8b\u4f53",FangSong:"\u4eff\u5b8b","PingFang SC":"\u82f9\u65b9",STHeiti:"\u534e\u6587\u9ed1\u4f53",STKaiti:"\u534e\u6587\u6977\u4f53",STSong:"\u534e\u6587\u5b8b\u4f53",STFangsong:"\u534e\u6587\u4eff\u5b8b",STZhongsong:"\u534e\u6587\u4e2d\u5b8b",STHupo:"\u534e\u6587\u7425\u73c0",STXinwei:"\u534e\u6587\u65b0\u9b4f",STLiti:"\u534e\u6587\u96b6\u4e66",STXingkai:"\u534e\u6587\u884c\u6977","Hiragino Sans GB":"\u51ac\u9752\u9ed1\u4f53\u7b80","Lantinghei SC":"\u5170\u4ead\u9ed1-\u7b80","Hanzipen SC":"\u7fe9\u7fe9\u4f53-\u7b80","Hannotate SC":"\u624b\u672d\u4f53-\u7b80","Songti SC":"\u5b8b\u4f53-\u7b80","Wawati SC":"\u5a03\u5a03\u4f53-\u7b80","Weibei SC":"\u9b4f\u7891-\u7b80","Xingkai SC":"\u884c\u6977-\u7b80","Yapi SC":"\u96c5\u75de-\u7b80","Yuanti SC":"\u5706\u4f53-\u7b80",YouYuan:"\u5e7c\u5706",LiSu:"\u96b6\u4e66",STXihei:"\u534e\u6587\u7ec6\u9ed1",STCaiyun:"\u534e\u6587\u5f69\u4e91",FZShuTi:"\u65b9\u6b63\u8212\u4f53",FZYaoti:"\u65b9\u6b63\u59da\u4f53"},xt="[DefaultFactory]";class bt{constructor(){this._z=0,this._time=0,this._shapeTemplates={},this.resizer={size:10},this.rotator={size:10,distance:30},this._shapeDecoration=new _t}get type(){return e.kD.Default}shapeTemplate(t){const e=this._shapeTemplates[t]||this.newShapeData(t);return this._shapeTemplates[t]=e,e}setShapeTemplate(t,e){this._shapeTemplates[t]=e}newWhiteBoard(t){return new ct(this,t)}newShapesMgr(){return new pt}newTool(t){const e=L.tool(t);if(!e)return console.warn(xt,`newTool("${t}"), ${t} is not registered`),new yt;const i=e();return i.type!==t&&console.warn(xt,`newTool("${t}"), ${t} is not corrent! check member 'type' of your Tool!`),i}newShapeData(t){const e=L.shapeData(t);if(!e)return console.warn(xt,`newShapeData("${t}"), ${t} is not registered`),new f;const i=e();return i.type!==t&&console.warn(xt,`newShapeData("${t}"), ${t} is not corrent! check member 'type' of your ShapeData!`),i}newId(t){return t.t+"_"+Date.now()+ ++this._time}newZ(t){return Date.now()+ ++this._z}newShape(t){var e,i;const s=c(t)||_(t),r=s?t:t.t,h=this.newShapeData(r),o=s?this.shapeTemplate(t):t;return h.read(o),s&&(h.id=this.newId(h),h.z=this.newZ(h)),null!==(i=null===(e=L.shape(r))||void 0===e?void 0:e(h))&&void 0!==i?i:new S(h,f)}newLayerId(){return`layer_${Date.now()}_${++this._time}`}newLayerName(){return`layer_${Date.now()}_${++this._time}`}newLayer(t){const e=t||{},{info:i}=e,s=ut(e,["info"]),r=i||{},{id:h=this.newLayerId(),name:o=this.newLayerName()}=r,n=ut(r,["id","name"]),a=Object.assign({info:Object.assign({id:h,name:o},n)},s);return new lt(a)}fontFamilies(){return e.IX.check(vt)}fontName(t){var e;return null!==(e=wt[t])&&void 0!==e?e:t}shapeDecoration(t){return this._shapeDecoration}overbound(t){return 1}}L.registerFactory(e.kD.Default,()=>new bt,{name:"bulit-in Factory",desc:"bulit-in Factory"});class St extends S{get target(){return this._target}get _distance(){var t;return(null===(t=this.board)||void 0===t?void 0:t.factory.rotator.distance)||30}get _width(){var t;return(null===(t=this.board)||void 0===t?void 0:t.factory.rotator.size)||10}constructor(){super({},f),this._ctrlDot=new n(0,0,0,0),this._oY=0,this._oX=0,this._update=t=>{var e;this.beginDirty();const{x:i,y:s}=t.rotatedMid,r=this._width,h=this._distance,o=t.visible&&t.selected&&!t.locked&&!!t.board;if(o){this.data.w=r,this.data.h=t.h+2*h,this.data.x=i-this.halfW,this.data.y=s-this.halfH,this.data.rotation=t.rotation;const o=(null===(e=this.board)||void 0===e?void 0:e.factory.rotator.size)||10;this._ctrlDot.w=o,this._ctrlDot.h=o}this.data.visible=o,this.endDirty()},this._listener1=t=>this._update(t.detail.shape),this._listener2=t=>this._update(t.detail.shape),this.data.ghost=!0,this.data.visible=!1}follow(t){this.unfollow(),t.addEventListener(e.r0.EndDirty,this._listener1),t.addEventListener(e.r0.BoardChanged,this._listener2),this._update(t),this._target=t}unfollow(){var t,i;null===(t=this._target)||void 0===t||t.removeEventListener(e.r0.EndDirty,this._listener1),null===(i=this._target)||void 0===i||i.removeEventListener(e.r0.BoardChanged,this._listener2),delete this._target}render(t){if(!this.visible)return;this.beginDraw(t);const{x:e,y:i,w:s,h:r}=this._ctrlDot,h=Math.floor(e+s/2)-.5;t.strokeStyle="black",t.fillStyle="white",t.lineWidth=1,t.beginPath(),t.arc(e+s/2,i+s/2,s/2,0,2*Math.PI),t.fill(),t.stroke(),t.beginPath(),t.moveTo(h,i+r),t.lineTo(h,this._distance),t.stroke(),this.endDraw(t)}pointerDown(t){const e=this.visible&&!!this._target&&this.hit(t);return e&&(this._oX=this._target.midX,this._oY=this._target.midY),e}pointerDraw(t){var i;const s=this._oX-t.x,r=this._oY-t.y;e.FQ.equals(s+r,0)||null===(i=this._target)||void 0===i||i.rotateTo(Math.atan2(r,s)-Math.PI/2)}hit(t){return this._ctrlDot.hit(this.map2me(t.x,t.y))}}class Dt extends Z{constructor(){super(new f),this.data.lineWidth=2,this.data.strokeStyle="#003388FF",this.data.fillStyle="#00338855",this.data.ghost=!0}}class Tt extends Z{constructor(){super(new f),this._targets=[],this._geo=new n(Number.MAX_VALUE,Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this.data.selected=!0,this.data.visible=!1}hit(t){if(!this.visible)return null;const e=this.map2me(t.x,t.y).plus(this.data);return this.getGeo().hit(e)?this.resizeDirection(e.x,e.y):null}reset(){this._targets=[],this.visible=!1,this._geo.x=Number.MAX_VALUE,this._geo.y=Number.MAX_VALUE,this._geo.w=-Number.MAX_VALUE,this._geo.h=-Number.MAX_VALUE,this.rotateTo(0)}setShapes(t){this.reset();const e=this.data.rotation,i=this._geo;this._targets=[];for(let h=0,o=t.length;h<o;++h){const s=t[h],{rotatedTopLeft:r,rotatedTopRight:o,rotatedBottomLeft:n,rotatedBottomRight:a,locked:d}=s;d||(this._targets.push({shape:s,midX:s.midX,midY:s.midY,rotation:s.rotation-e,degree:0,distance:0}),i.left=Math.min(i.left,r.x,o.x,n.x,a.x),i.right=Math.max(i.right,r.x,o.x,n.x,a.x),i.top=Math.min(i.top,r.y,o.y,n.y,a.y),i.bottom=Math.max(i.bottom,r.y,o.y,n.y,a.y))}const{x:s,y:r}=i.mid();for(let h=0,o=this._targets.length;h<o;++h){const{midX:t,midY:i}=this._targets[h],o=t-s,n=i-r;this._targets[h].distance=Math.sqrt(o*o+n*n),this._targets[h].degree=Math.atan2(n,o)-e}this.setGeo(i),this.visible=!0}rotateTo(t){super.rotateTo(t);const{midX:e,midY:i}=this;for(let s=0,r=this._targets.length;s<r;++s){const{shape:r,rotation:h,distance:o,degree:n}=this._targets[s];r.rotateTo(t+h);const a=Math.cos(t+n),d=Math.sin(t+n);r.move(a*o+e-r.w/2,d*o+i-r.h/2)}}}var Ct;e.o_=void 0,(Ct=e.o_||(e.o_={}))[Ct.Idle=0]="Idle",Ct[Ct.ReadyForDragging=1]="ReadyForDragging",Ct[Ct.Dragging=2]="Dragging",Ct[Ct.ReadyForSelecting=3]="ReadyForSelecting",Ct[Ct.Selecting=4]="Selecting",Ct[Ct.ReadyForResizing=5]="ReadyForResizing",Ct[Ct.Resizing=6]="Resizing",Ct[Ct.ReadyForRotating=7]="ReadyForRotating",Ct[Ct.Rotating=8]="Rotating";class kt{constructor(){this._doubleClickTimer=0,this._picking=new Tt,this._selector=new Dt,this._rectHelper=new A,this._status=e.o_.Idle,this._prevPos={x:0,y:0},this._resizer={direction:e.Cr.None,anchor:{x:0,y:0},offset:{x:0,y:0},shape:null},this._rotator=new St,this._windowPointerDown=()=>this.deselect(),this._shapes=[],this.onSelectChanged=()=>{this._picking.reset();const{selects:t}=this.board;t.length>1?(this._picking.setShapes(t),this._rotator.follow(this._picking)):this._picking.reset()},this.emitGeoEvent=function(t,e){let i,s=!1;return Object.assign(function(){return s||(s=!0,i=e(...arguments),setTimeout(()=>s=!1,t)),i},{enforce:e})}(1e3/30,t=>{const{board:i,_shapes:s}=this;i&&s.length&&(t?i.emitEvent(e._L.ShapesGeoChanged,{operator:i.whoami,tool:this.type,shapeDatas:this._shapes.map(t=>[e.sV.pickShapeGeoData(t.shape.data),t.startData])}):i.emitEvent(e._L.ShapesGeoChanging,{operator:i.whoami,tool:this.type,shapeDatas:this._shapes.map(t=>[e.sV.pickShapeGeoData(t.shape.data),t.prevData])}))})}get type(){return e.s8.Selector}get board(){return this._selector.board}set board(t){this._selector.board=t,this._rotator.board=t,this._picking.board=t,t.addEventListener(e._L.ShapesSelected,this.onSelectChanged),t.addEventListener(e._L.ShapesDeselected,this.onSelectChanged)}get rect(){return this._rectHelper}set cursor(t){this.board.element.style.cursor=t}render(t){this._selector.render(t),this._rotator.render(t),this._picking.render(t)}start(){this.board.element.style.cursor="",document.addEventListener("pointerdown",this._windowPointerDown)}end(){this.board.element.style.cursor="",document.removeEventListener("pointerdown",this._windowPointerDown),this.deselect(),this._rotator.unfollow()}deselect(){const{board:t}=this;t&&t.deselect(!0)}connect(t,e,i){let s=e,r=i;return this._shapes=t.map(t=>{const i={i:t.data.i,x:t.data.x,y:t.data.y,w:t.data.w,h:t.data.h,r:t.data.r};return void 0===e&&(s=void 0===s?t.data.x:Math.min(s,t.data.x),r=void 0===r?t.data.y:Math.min(r,t.data.y)),{shape:t,prevData:i,startData:i}}),this._prevPos={x:s,y:r},this}move(t,e){return this.moveBy(t-this._prevPos.x,e-this._prevPos.y)}moveBy(t,i){this._prevPos.x+=t,this._prevPos.y+=i;for(let s=0,r=this._shapes.length;s<r;++s){const r=this._shapes[s],{rotatedTopLeft:h,rotatedTopRight:o,rotatedBottomLeft:n,rotatedBottomRight:a,locked:d}=r.shape;d||(r.prevData=e.sV.pickShapePosData(r.shape.data),r.shape.moveBy(t,i))}return this._picking.moveBy(t,i),this}pointerDown(t){const{board:i,_status:s}=this;if(s!==e.o_.Idle)return;const{x:r,y:h}=t;if(this._rotator.pointerDown(t))return this._status=e.o_.ReadyForRotating,void this.connect([this._rotator.target],r,h);if(this._picking.hit(t))return this._status=e.o_.ReadyForDragging,void this.connect(i.selects,r,h);this._rectHelper.start(r,h),this.updateGeo();const o=i.hits({x:r,y:h,w:0,h:0}),n=e.DO.firstOf(o,t=>t.selected&&!t.locked?t:null)||o[0];if(!n||n.locked)this._status=e.o_.ReadyForSelecting,this._selector.visible=!0,this.deselect();else if(n.selected){const t=n.map2me(r,h).plus(n.data),[s,o]=n.resizeDirection(t.x,t.y);if(s){switch(this._resizer.direction=s,this._resizer.shape=n,s){case e.Cr.Top:this._resizer.offset.x=0,this._resizer.offset.y=o.top-t.y,this._resizer.anchor=n.rotatedMidBottom;break;case e.Cr.Bottom:this._resizer.offset.x=0,this._resizer.offset.y=o.bottom-t.y,this._resizer.anchor=n.rotatedMidTop;break;case e.Cr.Left:this._resizer.offset.x=o.left-t.x,this._resizer.offset.y=0,this._resizer.anchor=n.rotatedMidRight;break;case e.Cr.Right:this._resizer.offset.x=o.right-t.x,this._resizer.offset.y=0,this._resizer.anchor=n.rotatedMidLeft;break;case e.Cr.TopLeft:this._resizer.offset.x=o.left-t.x,this._resizer.offset.y=o.top-t.y,this._resizer.anchor=n.rotatedBottomRight;break;case e.Cr.TopRight:this._resizer.offset.x=o.right-t.x,this._resizer.offset.y=o.top-t.y,this._resizer.anchor=n.rotatedBottomLeft;break;case e.Cr.BottomLeft:this._resizer.offset.x=o.left-t.x,this._resizer.offset.y=o.bottom-t.y,this._resizer.anchor=n.rotatedTopRight;break;case e.Cr.BottomRight:this._resizer.offset.x=o.right-t.x,this._resizer.offset.y=o.bottom-t.y,this._resizer.anchor=n.rotatedTopLeft}this._status=e.o_.ReadyForResizing,i.setSelects([n],!0)}else this._status=e.o_.ReadyForDragging}else this._status=e.o_.ReadyForDragging,this._rotator.follow(n),i.setSelects([n],!0);this.connect(i.selects,r,h)}pointerMove(t){if(this._rotator.hit(t))return void(this.cursor="crosshair");const i=this._picking.hit(t);if(i)return void(this.cursor=this.getReiszerCursor(i[0],this._picking));const s=e.DO.firstOf(this.board.selects,e=>{const{x:i,y:s}=e.map2me(t.x,t.y).plus(e.data);if(e.locked)return null;if(!e.getGeo().hit({x:i,y:s}))return null;const[r]=e.resizeDirection(i,s);return[r,e]});this.cursor=s?this.getReiszerCursor(...s):""}getReiszerCursor(t,i){const{rotation:s}=i;if(!t)return"move";switch(Math.floor((25+e.a3.angle(e.a3.normalized(s+(t-1)*Math.PI*.25)))/45)%8){case 0:case 4:return"ns-resize";case 2:case 6:return"ew-resize";case 3:case 7:return"nw-resize";case 1:case 5:return"ne-resize"}return""}pointerDraw(t){var i;const s=this.board;if(s)switch(this._status){case e.o_.ReadyForRotating:this._status=e.o_.Rotating;case e.o_.Rotating:this._rotator.pointerDraw(t),this.emitGeoEvent(!1);break;case e.o_.ReadyForSelecting:if(d.manhattan(this._prevPos,t)<5)return;this._status=e.o_.Selecting;case e.o_.Selecting:return this._rectHelper.end(t.x,t.y),this.updateGeo(),void s.selectAt(this._selector.data,!0);case e.o_.ReadyForDragging:if(d.manhattan(this._prevPos,t)<5)return;this._status=e.o_.Dragging;case e.o_.Dragging:return void this.move(t.x,t.y).emitGeoEvent(!1);case e.o_.ReadyForResizing:if(d.manhattan(this._prevPos,t)<5)return;this._status=e.o_.Resizing;case e.o_.Resizing:{const{shape:r,offset:h,anchor:o,direction:n}=this._resizer;if(!r)return;const a=r.getGeo(),d=s.factory.resizer.size,{y:l,x:c}=h,{x:_,y:u}=r.map2me(t.x,t.y).plus(r),{left:p,right:g,bottom:y,top:m}=a;switch(n){case e.Cr.Top:a.top=Math.min(l+u,y-3*d);break;case e.Cr.Bottom:a.bottom=Math.max(l+u,m+3*d);break;case e.Cr.Left:a.left=Math.min(c+_,g-3*d);break;case e.Cr.Right:a.right=Math.max(c+_,p+3*d);break;case e.Cr.TopLeft:a.top=Math.min(l+u,y-3*d),a.left=Math.min(c+_,g-3*d);break;case e.Cr.TopRight:a.top=Math.min(l+u,y-3*d),a.right=Math.max(c+_,p+3*d);break;case e.Cr.BottomLeft:a.bottom=Math.max(l+u,m+3*d),a.left=Math.min(c+_,g-3*d);break;case e.Cr.BottomRight:a.bottom=Math.max(l+u,m+3*d),a.right=Math.max(c+_,p+3*d)}const f=null!==(i=r.data.r)&&void 0!==i?i:0,v=n-1,w=0==v||4==v?a.h:2==v||6==v?a.w:Math.sqrt(a.w*a.w+a.h*a.h);let x=f+Math.PI*v/4;1==v||5==v?x+=Math.atan2(a.w,a.h)-Math.PI/4:3!=v&&7!=v||(x+=Math.atan2(a.h,a.w)-Math.PI/4);const b=Math.sin(x),S=Math.cos(x),D=o.x+b*w/2,T=o.y-S*w/2;return r.geo(D-a.w/2,T-a.h/2,a.w,a.h),void this.emitGeoEvent(!1)}}}pointerUp(){switch(this._status){case e.o_.ReadyForDragging:this._doubleClickTimer?(clearTimeout(this._doubleClickTimer),this._doubleClickTimer=0,this.doubleClick()):this._doubleClickTimer=setTimeout(()=>this._doubleClickTimer=0,500);break;case e.o_.Rotating:case e.o_.Resizing:case e.o_.Dragging:this.emitGeoEvent.enforce(!0)}this._selector.visible=!1,this._rectHelper.clear(),this._status=e.o_.Idle}doubleClick(){const{board:t}=this;if(t&&this._shapes.length&&this._shapes[0].shape instanceof st){t.setToolType(e.s8.Text);const i=t.tool;i.selectorCallback=()=>t.setToolType(e.s8.Selector),i.editor.addEventListener("blur",i.selectorCallback,{once:!0}),i.connect(this._shapes[0].shape)}}updateGeo(){const{x:t,y:e,w:i,h:s}=this._rectHelper.gen();this._selector.geo(t,e,i,s)}}L.registerTool(e.s8.Selector,()=>new kt,{name:"Selector",desc:"pick shapes"});const Lt=(t,e,i)=>{e.forEach(e=>{var s;const r=e[i],h=r.i;h&&(null===(s=t.find(h))||void 0===s||s.merge(r))})},Rt=(t,e)=>{const i=e.map(e=>t.factory.newShape(e));t.add(i,{operator:"action_queue"})},Mt=(t,e)=>{const i=null===e||void 0===e?void 0:e.map(e=>t.find(e.i)).filter(t=>t);t.remove(i,{operator:"action_queue"})};L.registAction(e._L.ShapesDone,{isAction:()=>!0,undo:(t,e)=>{const{detail:{shapeDatas:i}}=e;Mt(t,i)},redo:(t,e)=>{const{detail:{shapeDatas:i}}=e;Rt(t,i)}}),L.registAction(e._L.ShapesRemoved,{isAction:()=>!0,undo:(t,e)=>{const{detail:{shapeDatas:i}}=e;Rt(t,i)},redo:(t,e)=>{const{detail:{shapeDatas:i}}=e;Mt(t,i)}}),L.registAction(e._L.ShapesGeoChanged,{isAction:(t,i)=>{const s=i.detail.tool===e.s8.Selector;return console.log("isAction:",s),s},undo:(t,i)=>{const{detail:{shapeDatas:s}}=i;Lt(t,s,1),t.emitEvent(e._L.ShapesGeoChanged,{operator:"action_queue",tool:e.s8.Invalid,shapeDatas:s.map(t=>[t[1],t[0]])})},redo:(t,i)=>{const{detail:{shapeDatas:s}}=i;Lt(t,s,0),t.emitEvent(e._L.ShapesGeoChanged,{operator:"action_queue",tool:e.s8.Invalid,shapeDatas:s})}});e.HA=L,e.yp=S,e.Yi=f}}]);
//# sourceMappingURL=354.ae8c8c55.chunk.js.map